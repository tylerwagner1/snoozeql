---
phase: 06-intelligent-recommendations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/lib/api.ts
  - web/src/components/RecommendationCard.tsx
  - web/src/components/RecommendationModal.tsx
  - web/src/components/ActivityGraph.tsx
autonomous: true

must_haves:
  truths:
    - "Recommendation cards display instance name, confidence label, and savings estimate"
    - "Cards are collapsible with expand/collapse for details"
    - "Modal shows activity graph and suggested schedule times"
  artifacts:
    - path: "web/src/components/RecommendationCard.tsx"
      provides: "Collapsible recommendation list item"
      min_lines: 80
    - path: "web/src/components/RecommendationModal.tsx"
      provides: "Details modal with confirm action"
      min_lines: 100
    - path: "web/src/components/ActivityGraph.tsx"
      provides: "24-hour CPU activity visualization"
      min_lines: 50
    - path: "web/src/lib/api.ts"
      provides: "Updated Recommendation type and API methods"
      contains: "generateRecommendations"
  key_links:
    - from: "web/src/components/RecommendationCard.tsx"
      to: "web/src/components/RecommendationModal.tsx"
      via: "onClick opens modal"
      pattern: "onOpenModal"
    - from: "web/src/components/RecommendationModal.tsx"
      to: "web/src/components/ActivityGraph.tsx"
      via: "renders activity graph"
      pattern: "<ActivityGraph"
---

<objective>
Create React components for displaying and interacting with recommendations.

Purpose: Provide the UI building blocks for the recommendation system - collapsible cards with expand/collapse pattern, details modal with activity visualization, and API type updates.

Output: Three new components (RecommendationCard, RecommendationModal, ActivityGraph) and updated API types.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-intelligent-recommendations/06-CONTEXT.md
@.planning/phases/06-intelligent-recommendations/06-RESEARCH.md

# Existing patterns to follow
@web/src/components/FilterPreview.tsx
@web/src/components/ConfirmDialog.tsx
@web/src/lib/api.ts
@web/src/lib/cronUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update API types and methods</name>
  <files>web/src/lib/api.ts</files>
  <action>
Update web/src/lib/api.ts with new recommendation types and API methods:

1. Replace existing Recommendation interface with RecommendationEnriched:
```typescript
export interface RecommendationEnriched {
  id: string;
  instance_id: string;
  instance_name: string;
  provider: string;
  region: string;
  engine: string;
  detected_pattern: {
    idle_start_hour: number;
    idle_end_hour: number;
    days_of_week: string[];
    avg_cpu: number;
    confidence: number;
  };
  suggested_schedule: {
    timezone: string;
    sleep_cron: string;
    wake_cron: string;
  };
  confidence_score: number;
  estimated_daily_savings: number;
  status: 'pending' | 'approved' | 'dismissed';
  created_at: string;
}
```

2. Update recommendation API methods:
```typescript
// Recommendations
getRecommendations: (status?: string) => {
  const params = status ? `?status=${status}` : '';
  return api.get<RecommendationEnriched[]>(`/recommendations${params}`);
},
generateRecommendations: () => 
  api.post<{ created: number; message: string }>('/recommendations/generate'),
dismissRecommendation: (id: string) => 
  api.post<void>(`/recommendations/${id}/dismiss`),
confirmRecommendation: (id: string) => 
  api.post<{ schedule_id: string }>(`/recommendations/${id}/confirm`),
```

3. Remove old applyRecommendation and ignoreRecommendation methods (replaced by dismiss/confirm).

4. Keep the old Recommendation type for backward compatibility but mark with comment "// DEPRECATED - use RecommendationEnriched".
  </action>
  <verify>
Run: `cd web && npm run build` - should compile without TypeScript errors
  </verify>
  <done>
API types updated with RecommendationEnriched interface and new API methods for generate/dismiss/confirm.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create recommendation components</name>
  <files>web/src/components/RecommendationCard.tsx, web/src/components/RecommendationModal.tsx, web/src/components/ActivityGraph.tsx</files>
  <action>
Create three new components following existing patterns:

**1. web/src/components/ActivityGraph.tsx:**
Create 24-hour activity visualization using recharts (already in package.json):
- Accept props: pattern: { idle_start_hour: number; idle_end_hour: number; avg_cpu?: number }
- Generate 24-hour data array with hour labels (0-23)
- Mark idle window visually (lower values during idle hours)
- Use AreaChart with gradient fill following Dashboard.tsx pattern
- Add ReferenceLine markers for sleep/wake times with labels
- Use slate-800/900 dark theme colors
- Height: ~128px (h-32)

**2. web/src/components/RecommendationCard.tsx:**
Create collapsible list item following FilterPreview.tsx expand/collapse pattern:
- Accept props: recommendation: RecommendationEnriched, onOpenModal: (rec) => void, onDismiss: (id) => void
- Summary row (always visible):
  - "AI Suggested" purple badge (bg-purple-500/10 text-purple-400 border-purple-500/30)
  - Instance name (font-medium text-white)
  - Confidence label badge: High (>=80, green), Medium (50-79, yellow), Low (<50, orange) per CONTEXT.md
  - Estimated savings: ${estimated_daily_savings.toFixed(2)}/day in green
  - ChevronUp/ChevronDown icon for expand state
- Expanded section (conditional render):
  - Activity pattern summary text
  - Suggested sleep/wake times using describeCron from cronUtils
  - "View Details" button (opens modal via onOpenModal)
  - "Mark as Not Now" button (calls onDismiss) per CONTEXT.md
- Use useState for expanded state
- Clickable header row to toggle expanded
- bg-slate-800/50 rounded-xl border border-slate-700 styling

**3. web/src/components/RecommendationModal.tsx:**
Create details modal following ConfirmDialog.tsx and ScheduleModal.tsx patterns:
- Accept props: isOpen, onClose, recommendation: RecommendationEnriched | null, onConfirm: (id) => Promise<void>, loading?: boolean
- Use Headless UI Dialog (Dialog, DialogPanel, DialogTitle, DialogBackdrop)
- Header: "Confirm Schedule Recommendation" title + X close button
- Instance info: AI Suggested badge + instance name
- Activity pattern section:
  - Section title "Detected Activity Pattern"
  - Render ActivityGraph component with pattern data
- Suggested schedule section:
  - Two columns: Sleep at / Wake at
  - Show describeCron() output for each CRON
  - Use Clock icon from lucide-react
- Savings summary:
  - Green highlight box (bg-green-500/10 border-green-500/30)
  - TrendingDown icon
  - "Estimated savings: ${estimated_daily_savings.toFixed(2)}/day"
- Confidence text: "{High/Medium/Low} confidence - based on X days of consistent activity patterns"
- Action buttons: Cancel (slate), Create Schedule (green, calls onConfirm with loading state)
  </action>
  <verify>
Run: `cd web && npm run build` - should compile without TypeScript errors
Run: `cd web && npm run dev` - should start without errors (components not yet used in pages)
  </verify>
  <done>
Three components created: ActivityGraph renders 24-hour visualization, RecommendationCard shows collapsible list items, RecommendationModal shows full details with confirm action.
  </done>
</task>

</tasks>

<verification>
After completing both tasks:
1. `cd web && npm run build` compiles without errors
2. Components export correctly from their files
3. No TypeScript errors in IDE
4. Development server starts without errors
</verification>

<success_criteria>
- RecommendationEnriched type matches backend API response structure
- API methods updated for generate/dismiss/confirm endpoints
- RecommendationCard has collapsible expand/collapse with confidence labels (High/Medium/Low)
- RecommendationModal shows activity graph and schedule details
- ActivityGraph visualizes 24-hour pattern with idle window highlighted
</success_criteria>

<output>
After completion, create `.planning/phases/06-intelligent-recommendations/06-02-SUMMARY.md`
</output>
