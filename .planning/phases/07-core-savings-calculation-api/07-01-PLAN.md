---
phase: 07-core-savings-calculation-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - deployments/docker/migrations/006_cost_tracking.sql
  - internal/store/savings_store.go
  - internal/savings/calculator.go
autonomous: true

must_haves:
  truths:
    - "Savings records can be created and retrieved from database"
    - "Savings amounts are accurate to the cent"
    - "Savings reflect actual stopped time (up to AWS 7-day restart limits)"
    - "Savings are aggregated by date for each instance"
  artifacts:
    - path: "deployments/docker/migrations/006_cost_tracking.sql"
      provides: "Database indexes and materialized view for savings queries"
      contains: "CREATE INDEX idx_events_instance_time"
    - path: "internal/store/savings_store.go"
      provides: "SavingsStore with CRUD operations"
      exports: ["NewSavingsStore", "UpsertDailySaving", "GetSavingsByInstance", "GetTotalSavings", "GetDailySavings", "GetTopSavers"]
    - path: "internal/savings/calculator.go"
      provides: "SavingsCalculator with core calculation logic"
      exports: ["NewSavingsCalculator", "CalculateSavings", "CalculateOngoingSavings"]
  key_links:
    - from: "internal/savings/calculator.go"
      to: "internal/models/models.go"
      via: "uses Saving, Event, Instance models"
      pattern: "models\\.Saving"
    - from: "internal/store/savings_store.go"
      to: "internal/store/postgres.go"
      via: "uses Postgres connection wrapper"
      pattern: "\\*Postgres"
---

<objective>
Create the database migration, SavingsStore, and SavingsCalculator that form the foundation for cost savings tracking.

Purpose: Establishes the data layer and core calculation logic that all subsequent savings features depend on. Without this foundation, neither the event decorator nor the API endpoints can function.

Output: 
- Migration 006 with indexes for time-range queries and materialized view for dashboard performance
- SavingsStore with upsert/query methods following existing store patterns
- SavingsCalculator with duration Ã— hourly_cost_cents logic, 7-day cap, and ongoing savings calculation
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@internal/store/postgres.go
@internal/models/models.go
@deployments/docker/migrations/001_base_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for cost tracking indexes and materialized view</name>
  <files>deployments/docker/migrations/006_cost_tracking.sql</files>
  <action>
Create migration file with:

1. Add index for time-range queries on events:
   - `idx_events_instance_time ON events(instance_id, created_at DESC)` - for finding last stop event per instance
   - `idx_events_type_time ON events(event_type, created_at)` - for filtering by event type

2. Add `hourly_rate_cents` column to savings table:
   - `ALTER TABLE savings ADD COLUMN hourly_rate_cents INTEGER` - stores rate at time of calculation (AUD-02)

3. Create materialized view `savings_summary` for dashboard performance:
   ```sql
   CREATE MATERIALIZED VIEW savings_summary AS
   SELECT 
       instance_id,
       DATE_TRUNC('day', date) as day,
       DATE_TRUNC('week', date) as week,
       DATE_TRUNC('month', date) as month,
       SUM(stopped_minutes) as total_stopped_minutes,
       SUM(estimated_savings_cents) as total_savings_cents
   FROM savings
   GROUP BY instance_id, DATE_TRUNC('day', date), DATE_TRUNC('week', date), DATE_TRUNC('month', date);
   ```

4. Add unique index on materialized view:
   - `idx_savings_summary_instance_day ON savings_summary(instance_id, day)`

Follow existing migration naming pattern (e.g., 005_metrics_hourly.sql).
  </action>
  <verify>
- File exists: `ls deployments/docker/migrations/006_cost_tracking.sql`
- Contains required elements: `grep -E "(idx_events_instance_time|idx_events_type_time|hourly_rate_cents|savings_summary)" deployments/docker/migrations/006_cost_tracking.sql`
  </verify>
  <done>
- Migration file exists with indexes for events table
- savings table has hourly_rate_cents column added
- Materialized view savings_summary created with unique index
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SavingsStore with CRUD operations</name>
  <files>internal/store/savings_store.go</files>
  <action>
Create SavingsStore following the pattern from RecommendationStore/EventStore in postgres.go:

1. Define SavingsStore struct with `db *Postgres` field
2. NewSavingsStore constructor

3. UpsertDailySaving method:
   - INSERT ... ON CONFLICT (instance_id, date) DO UPDATE
   - Accumulates stopped_minutes and estimated_savings_cents for the same day
   - Sets hourly_rate_cents to latest value

4. GetSavingsByInstance method:
   - Query savings for a specific instance within date range
   - ORDER BY date DESC

5. GetTotalSavings method:
   - SUM(estimated_savings_cents) within date range
   - Returns total as int (cents)

6. GetDailySavings method:
   - Get daily breakdown for time range
   - Returns []struct{Date, SavingsCents, StoppedMinutes}

7. GetTopSavers method:
   - Get instances with highest savings in time range
   - JOIN with instances to get name
   - Returns []struct{InstanceID, Name, SavingsCents, StoppedHours}
   - ORDER BY savings_cents DESC LIMIT N

8. RefreshSavingsSummary method:
   - REFRESH MATERIALIZED VIEW savings_summary

Use integer cents throughout (no float64 for money). Follow existing error handling patterns.
  </action>
  <verify>
- File compiles: `go build ./internal/store/...`
- Exports exist: `grep -E "func.*NewSavingsStore|func.*UpsertDailySaving|func.*GetTotalSavings" internal/store/savings_store.go`
  </verify>
  <done>
- SavingsStore struct with Postgres connection
- UpsertDailySaving accumulates daily savings per instance
- GetSavingsByInstance, GetTotalSavings, GetDailySavings, GetTopSavers query methods
- RefreshSavingsSummary for materialized view refresh
- All methods use integer cents, not float
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement SavingsCalculator with core calculation logic</name>
  <files>internal/savings/calculator.go</files>
  <action>
Create internal/savings/ directory and calculator.go:

1. Define constants:
   - `MaxStoppedDuration = 7 * 24 * time.Hour` (AWS 7-day auto-restart cap)

2. SavingsCalculator struct:
   - No external dependencies - pure calculation logic

3. NewSavingsCalculator constructor

4. CalculateSavings method:
   ```go
   func (c *SavingsCalculator) CalculateSavings(
       stoppedAt time.Time, 
       startedAt time.Time, 
       hourlyCostCents int,
   ) (stoppedMinutes int, savingsCents int)
   ```
   - Cap duration at MaxStoppedDuration (7 days)
   - Calculate: stoppedMinutes = int(duration.Minutes())
   - Calculate: savingsCents = (stoppedMinutes * hourlyCostCents) / 60
   - Use integer math only (no floating point)

5. CalculateOngoingSavings method:
   ```go
   func (c *SavingsCalculator) CalculateOngoingSavings(
       stoppedAt time.Time,
       hourlyCostCents int,
   ) (stoppedMinutes int, savingsCents int)
   ```
   - Uses time.Now() as end time
   - Same calculation logic with 7-day cap
   - For currently-stopped instances

6. SplitByDay method:
   ```go
   func (c *SavingsCalculator) SplitByDay(
       stoppedAt time.Time,
       startedAt time.Time,
       hourlyCostCents int,
   ) []DailySaving
   ```
   - Splits a stop period across multiple days
   - Returns slice of {Date, StoppedMinutes, SavingsCents, HourlyRateCents}
   - Needed for daily aggregation

Add comprehensive comments explaining the 7-day cap rationale (AWS auto-restart).
  </action>
  <verify>
- Directory exists: `ls internal/savings/`
- File compiles: `go build ./internal/savings/...`
- 7-day cap present: `grep "MaxStoppedDuration" internal/savings/calculator.go`
- Uses integer math: `grep -v "float64" internal/savings/calculator.go | grep -c "savingsCents"` should be > 0
  </verify>
  <done>
- internal/savings/ package created
- SavingsCalculator with CalculateSavings, CalculateOngoingSavings, SplitByDay methods
- 7-day maximum duration cap implemented
- Integer cents math throughout (no floating point for money)
- Comments explain AWS auto-restart rationale
  </done>
</task>

</tasks>

<verification>
1. All files compile: `go build ./...`
2. Migration file is valid SQL: `psql` syntax check or migration tool dry-run
3. SavingsStore follows existing patterns (compare to EventStore, RecommendationStore)
4. SavingsCalculator uses integer math exclusively for money
5. 7-day cap is correctly applied in both CalculateSavings and CalculateOngoingSavings
</verification>

<success_criteria>
- Migration 006 exists with indexes and materialized view
- SavingsStore has all required methods exported
- SavingsCalculator correctly calculates savings with 7-day cap
- All code compiles without errors
- Integer cents pattern maintained (no float64 for currency)
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-savings-calculation-api/07-01-SUMMARY.md`
</output>
