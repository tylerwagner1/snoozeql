---
phase: 07-core-savings-calculation-api
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - internal/api/handlers/savings.go
  - cmd/server/main.go
autonomous: true

must_haves:
  truths:
    - "User can see total estimated savings in cents for any time range via API"
    - "User can retrieve daily savings breakdown with stopped minutes and savings per day"
    - "User can query savings attributed to specific instances"
    - "API returns ongoing savings for currently-stopped instances"
  artifacts:
    - path: "internal/api/handlers/savings.go"
      provides: "HTTP handlers for savings API endpoints"
      exports: ["NewSavingsHandler", "GetSavingsSummary", "GetDailySavings", "GetSavingsByInstance", "GetInstanceSavings"]
    - path: "cmd/server/main.go"
      provides: "Routes for savings API endpoints"
      contains: "r.Get(\"/savings\""
  key_links:
    - from: "internal/api/handlers/savings.go"
      to: "internal/store/savings_store.go"
      via: "queries savings data"
      pattern: "SavingsStore"
    - from: "internal/api/handlers/savings.go"
      to: "internal/savings/calculator.go"
      via: "calculates ongoing savings"
      pattern: "SavingsCalculator"
    - from: "cmd/server/main.go"
      to: "internal/api/handlers/savings.go"
      via: "registers HTTP routes"
      pattern: "savingsHandler"
---

<objective>
Implement the SavingsHandler with API endpoints for querying savings data, completing the backend for Phase 7.

Purpose: Exposes the calculated savings data via REST API for Phase 8 dashboard consumption. This is the final piece that makes savings data accessible to the frontend, satisfying SAV-02 (backend API portion).

Output:
- SavingsHandler with endpoints for summary, daily breakdown, and per-instance savings
- Routes registered in main.go following existing patterns
- Ongoing savings calculation for currently-stopped instances
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/phases/07-core-savings-calculation-api/07-01-SUMMARY.md
@internal/api/handlers/savings.go
@internal/api/handlers/recommendations.go
@cmd/server/main.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SavingsHandler with all endpoints</name>
  <files>internal/api/handlers/savings.go</files>
  <action>
Replace the stub savings.go with full implementation following RecommendationHandler patterns:

1. SavingsHandler struct:
   ```go
   type SavingsHandler struct {
       savingsStore   *store.SavingsStore
       instanceStore  *store.InstanceStore
       eventStore     *store.EventStore
       calculator     *savings.SavingsCalculator
   }
   ```

2. NewSavingsHandler constructor accepting all dependencies

3. GetSavingsSummary (GET /api/v1/savings):
   - Query params: `days` (default 30), `start`, `end` (ISO dates)
   - Calculate date range from params
   - Call savingsStore.GetTotalSavings for finalized savings
   - Calculate ongoing savings for currently-stopped instances:
     - List all instances with status "stopped"
     - For each, find last stop event and calculate ongoing savings
     - Sum all ongoing savings
   - Call savingsStore.GetTopSavers for top 5 instances
   - Response:
     ```json
     {
       "total_savings_cents": 12500,
       "ongoing_savings_cents": 340,
       "period": {"start": "2026-02-01", "end": "2026-02-23"},
       "top_savers": [
         {"instance_id": "...", "name": "...", "savings_cents": 5000, "stopped_hours": 120}
       ]
     }
     ```

4. GetDailySavings (GET /api/v1/savings/daily):
   - Query params: `days` (default 30), `start`, `end`
   - Call savingsStore.GetDailySavings
   - Response:
     ```json
     {
       "daily_savings": [
         {"date": "2026-02-23", "savings_cents": 450, "stopped_minutes": 720}
       ]
     }
     ```

5. GetSavingsByInstance (GET /api/v1/savings/by-instance):
   - Query params: `days` (default 30), `start`, `end`, `limit` (default 20)
   - Call savingsStore.GetTopSavers (or new method for all instances)
   - Enrich with instance details (name, provider, region)
   - Response:
     ```json
     [
       {
         "instance_id": "...",
         "name": "prod-db-1",
         "provider": "aws",
         "region": "us-east-1",
         "savings_cents": 5000,
         "stopped_hours": 120
       }
     ]
     ```

6. GetInstanceSavings (GET /api/v1/instances/{id}/savings):
   - Path param: instance ID
   - Query params: `days` (default 30)
   - Call savingsStore.GetSavingsByInstance
   - Include ongoing savings if instance is currently stopped
   - Response:
     ```json
     {
       "instance_id": "...",
       "total_savings_cents": 3500,
       "ongoing_savings_cents": 120,
       "savings": [
         {"date": "2026-02-23", "stopped_minutes": 180, "savings_cents": 150, "hourly_rate_cents": 50}
       ]
     }
     ```

7. PostBackfill (POST /api/v1/savings/backfill) - optional stretch goal:
   - Triggers historical savings calculation from existing events
   - Response: `{"status": "backfill_started"}`
   - Can be deferred to future phase

Use JSON encoding patterns from recommendations.go. Return proper HTTP status codes (200, 400, 404, 500).
  </action>
  <verify>
- File compiles: `go build ./internal/api/handlers/...`
- All endpoints exist: `grep -E "func.*Get(Savings|Daily|Instance)" internal/api/handlers/savings.go`
- Uses integer cents: `grep "savings_cents" internal/api/handlers/savings.go`
  </verify>
  <done>
- SavingsHandler struct with all dependencies
- GetSavingsSummary returns total, ongoing, and top savers
- GetDailySavings returns per-day breakdown
- GetSavingsByInstance returns per-instance attribution
- GetInstanceSavings returns detail for single instance
- All responses use integer cents, proper JSON encoding
  </done>
</task>

<task type="auto">
  <name>Task 2: Register savings API routes in main.go</name>
  <files>cmd/server/main.go</files>
  <action>
Add savings routes following the existing pattern for recommendations:

1. After the SavingsStore and SavingsCalculator creation (from Plan 07-02), create the handler:
   ```go
   savingsHandler := handlers.NewSavingsHandler(
       savingsStore,
       instanceStore,
       eventStore,
       savingsCalculator,
   )
   ```

2. Register routes in the /api/v1 route group (after recommendations routes, around line 650):
   ```go
   // Savings
   r.Get("/savings", savingsHandler.GetSavingsSummary)
   r.Get("/savings/daily", savingsHandler.GetDailySavings)
   r.Get("/savings/by-instance", savingsHandler.GetSavingsByInstance)
   r.Get("/instances/{id}/savings", func(w http.ResponseWriter, r *http.Request) {
       id := chi.URLParam(r, "id")
       savingsHandler.GetInstanceSavings(w, r, id)
   })
   ```

3. Optionally add backfill endpoint:
   ```go
   r.Post("/savings/backfill", savingsHandler.PostBackfill)
   ```

Follow the exact pattern used for recommendations (lines 628-649 in current main.go).
  </action>
  <verify>
- File compiles: `go build ./cmd/server/...`
- Routes registered: `grep -E 'r\.(Get|Post).*savings' cmd/server/main.go`
- Handler created: `grep "NewSavingsHandler" cmd/server/main.go`
  </verify>
  <done>
- SavingsHandler instantiated with all dependencies
- GET /api/v1/savings route registered
- GET /api/v1/savings/daily route registered
- GET /api/v1/savings/by-instance route registered
- GET /api/v1/instances/{id}/savings route registered
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual API verification</name>
  <files></files>
  <action>
Test the API endpoints work correctly:

1. Start the server: `go run ./cmd/server/...`

2. Test savings summary endpoint:
   ```bash
   curl -H "X-API-Key: $API_KEY" http://localhost:8080/api/v1/savings
   ```
   Expected: JSON with total_savings_cents, ongoing_savings_cents, period, top_savers

3. Test daily savings endpoint:
   ```bash
   curl -H "X-API-Key: $API_KEY" "http://localhost:8080/api/v1/savings/daily?days=7"
   ```
   Expected: JSON with daily_savings array

4. Test by-instance endpoint:
   ```bash
   curl -H "X-API-Key: $API_KEY" http://localhost:8080/api/v1/savings/by-instance
   ```
   Expected: JSON array of instances with savings

Note: If no savings data exists yet (no stop/start events), endpoints should return empty/zero values, not errors.
  </action>
  <verify>
- Server starts without errors
- All endpoints return valid JSON (not 500 errors)
- Empty data returns gracefully (empty arrays, zero values)
  </verify>
  <done>
- All 4 savings endpoints respond with valid JSON
- Server starts and runs without errors
- API matches documented response format from research
  </done>
</task>

</tasks>

<verification>
1. Full application compiles: `go build ./...`
2. Server starts: `go run ./cmd/server/...`
3. All endpoints return valid JSON:
   - GET /api/v1/savings returns summary with total_savings_cents
   - GET /api/v1/savings/daily returns daily_savings array
   - GET /api/v1/savings/by-instance returns instances array
   - GET /api/v1/instances/{id}/savings returns instance detail
4. Empty state (no savings) handled gracefully (no 500 errors)
</verification>

<success_criteria>
- SavingsHandler fully implemented with 4 endpoints
- Routes registered in main.go
- All endpoints return valid JSON responses
- Ongoing savings calculated for currently-stopped instances
- SAV-01: Savings calculation exposed via API
- SAV-02: Backend API ready for dashboard consumption
- Integer cents used throughout (no floating point)
</success_criteria>

<output>
After completion, create `.planning/phases/07-core-savings-calculation-api/07-03-SUMMARY.md`
</output>
