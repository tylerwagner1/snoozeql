---
phase: 04-advanced-schedule-filtering
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - web/src/components/ScheduleModal.tsx
  - web/src/pages/SchedulesPage.tsx
autonomous: false

must_haves:
  truths:
    - "User can create schedule filters in ScheduleModal"
    - "User can edit existing schedule filters"
    - "Schedule list shows instance count for each schedule"
    - "User can preview which instances match before saving"
    - "Filters are saved with schedule and persist"
  artifacts:
    - path: "web/src/components/ScheduleModal.tsx"
      provides: "Extended modal with filter builder section"
      min_lines: 400
    - path: "web/src/pages/SchedulesPage.tsx"
      provides: "Schedule list with instance counts"
      min_lines: 200
  key_links:
    - from: "web/src/components/ScheduleModal.tsx"
      to: "web/src/components/FilterBuilder.tsx"
      via: "import FilterBuilder"
      pattern: "import.*FilterBuilder"
    - from: "web/src/pages/SchedulesPage.tsx"
      to: "API schedule data"
      via: "selectors array in schedule"
      pattern: "schedule\\.selectors"
---

<objective>
Integrate FilterBuilder into ScheduleModal and update SchedulesPage to show instance counts.

Purpose: Complete the schedule filter workflow by adding the filter builder to the schedule creation/editing modal, and showing how many instances each schedule affects in the list view.

Output: ScheduleModal with integrated filter builder, SchedulesPage showing instance counts per schedule.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-advanced-schedule-filtering/04-CONTEXT.md
@.planning/phases/04-advanced-schedule-filtering/04-02-PLAN.md
@web/src/components/ScheduleModal.tsx
@web/src/components/FilterBuilder.tsx
@web/src/pages/SchedulesPage.tsx
@web/src/lib/api.ts
@web/src/lib/filterUtils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate FilterBuilder into ScheduleModal</name>
  <files>web/src/components/ScheduleModal.tsx</files>
  <action>
Update `web/src/components/ScheduleModal.tsx` to include the filter builder:

**Add imports:**
```typescript
import { FilterBuilder } from './FilterBuilder';
import type { Selector, Instance } from '../lib/api';
```

**Add selectors state alongside existing form state:**
```typescript
const [selectors, setSelectors] = useState<Selector[]>([]);
const [instances, setInstances] = useState<Instance[]>([]);
```

**Fetch instances on mount for preview:**
```typescript
// Add to existing useEffect or create new one
useEffect(() => {
  api.getInstances()
    .then(setInstances)
    .catch(console.error);
}, []);
```

**Initialize selectors in the form reset logic** (in the existing useEffect that handles isOpen):
```typescript
// In the existing useEffect that handles isOpen and schedule
if (isOpen) {
  if (schedule) {
    // Edit mode: populate from existing schedule
    // ... existing code ...
    setSelectors(schedule.selectors || []);
  } else {
    // Create mode: reset form
    // ... existing code ...
    setSelectors([]);
  }
}
```

**Add FilterBuilder section after the time selection section** (after the WeeklyScheduleGrid / CRON inputs):

Find the section that ends with the summary display (the `{/* Summary display */}` section), and add the filter builder AFTER it:

```tsx
{/* Filter Builder Section */}
<div className="mt-6 pt-6 border-t border-slate-700">
  <FilterBuilder
    selectors={selectors}
    onChange={setSelectors}
    instances={instances}
  />
</div>
```

**Update handleSubmit to include selectors:**
```typescript
const scheduleData: Omit<Schedule, 'id' | 'created_at' | 'updated_at'> = {
  name,
  description,
  timezone,
  selectors: selectors,  // Add this line (change from empty array)
  sleep_cron: showCronMode ? sleepCron : (gridToCron(grid)?.sleepCron || '0 22 * * 1-5'),
  wake_cron: showCronMode ? wakeCron : (gridToCron(grid)?.wakeCron || '0 7 * * 1-5'),
  enabled: true,
};
```

**Important:** Keep all existing functionality intact. The filter builder is an ADDITION to the modal, not a replacement of anything.
  </action>
  <verify>
1. TypeScript compiles: `cd web && npx tsc --noEmit`
2. ScheduleModal.tsx imports FilterBuilder
3. ScheduleModal.tsx has selectors state and passes to FilterBuilder
  </verify>
  <done>
- FilterBuilder integrated into ScheduleModal below time selection
- Selectors state managed in modal
- Selectors saved with schedule on submit
- Edit mode loads existing selectors
- TypeScript compiles
  </done>
</task>

<task type="auto">
  <name>Task 2: Add instance count to SchedulesPage</name>
  <files>web/src/pages/SchedulesPage.tsx</files>
  <action>
Update `web/src/pages/SchedulesPage.tsx` to show instance counts:

**Add imports:**
```typescript
import { matchInstance } from '../lib/filterUtils';
```

**Add instances state and fetch:**
```typescript
const [instances, setInstances] = useState<Instance[]>([]);

// Add to existing useEffect or create new one
useEffect(() => {
  api.getInstances()
    .then(setInstances)
    .catch(console.error);
}, []);
```

**Add helper function to count matched instances:**
```typescript
const getMatchedCount = (schedule: Schedule): number => {
  if (!schedule.selectors || schedule.selectors.length === 0) {
    return 0;
  }
  return instances.filter(inst => matchInstance(inst, schedule.selectors, 'and')).length;
};
```

**Add new column to table header** (after "Sleep Hours" column):
```tsx
<th className="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider">Instances</th>
```

**Add instance count cell in the table row** (after sleep hours cell, before status cell):
```tsx
<td className="px-6 py-4 whitespace-nowrap">
  <div className="flex items-center gap-2">
    {schedule.selectors && schedule.selectors.length > 0 ? (
      <>
        <span className="text-sm font-medium text-white">{getMatchedCount(schedule)}</span>
        <span className="text-xs text-slate-400">matched</span>
      </>
    ) : (
      <span className="text-xs text-slate-500">No filters</span>
    )}
  </div>
</td>
```

**Import Instance type:**
```typescript
import type { Schedule, Instance } from '../lib/api';
```

The table should now have columns: Name | Active Days | Sleep Hours | Instances | Status | Actions
  </action>
  <verify>
1. TypeScript compiles: `cd web && npx tsc --noEmit`
2. SchedulesPage.tsx imports matchInstance
3. Table has "Instances" column
  </verify>
  <done>
- SchedulesPage shows instance count column
- Count computed from selectors using matchInstance
- Shows "No filters" when schedule has no selectors
- TypeScript compiles
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete schedule filtering workflow:
- Backend matcher logic for instance selection
- Filter preview API endpoint
- FilterBuilder, FilterRule, FilterPreview components
- ScheduleModal integration with filter builder
- SchedulesPage showing instance counts per schedule
  </what-built>
  <how-to-verify>
1. Start the development servers:
   ```bash
   # Terminal 1: Backend
   cd /Users/tylerwagner/snoozeql && go run cmd/server/main.go
   
   # Terminal 2: Frontend
   cd /Users/tylerwagner/snoozeql/web && npm run dev
   ```

2. Open http://localhost:5173/schedules

3. **Test filter builder in create mode:**
   - Click "Create Schedule" button
   - Verify modal opens with:
     - Schedule name, description, timezone (from Phase 3)
     - Weekly grid for time selection (from Phase 3)
     - NEW: "Instance Filters" section at the bottom
   
4. **Test adding filter rules:**
   - Click "Add Filter Rule"
   - Verify a rule appears with dropdowns for:
     - Field type (Instance Name, Cloud Provider, Region, Engine, Tag)
     - Match type (contains, equals, starts with, ends with, matches regex)
     - Pattern input field
   - Verify preview panel shows "X of Y instances" count
   
5. **Test different filter types:**
   - Add a Name filter with "contains" and some text from an instance name
   - Verify preview updates showing matching instances
   - Change to "Cloud Provider" and select "AWS" or "GCP"
   - Verify preview shows only instances from that provider
   - Try "Tag" filter with a tag key and value

6. **Test AND/OR toggle:**
   - Add multiple filter rules
   - Verify AND/OR toggle appears between rules
   - Toggle between AND and OR
   - Verify preview count changes based on operator

7. **Test regex validation:**
   - Add a Name filter
   - Change match type to "matches regex"
   - Type an invalid regex like "[" (unclosed bracket)
   - Verify error message appears below the input

8. **Test schedule save with filters:**
   - Create a schedule with name, time selection, and filters
   - Click "Create Schedule"
   - Verify schedule appears in list
   - Verify "Instances" column shows the matched count

9. **Test edit mode:**
   - Click "Edit" on a schedule with filters
   - Verify filter builder shows existing filters
   - Modify a filter
   - Save and verify changes persist

10. **Test schedules page instance counts:**
    - Verify schedules list shows "Instances" column
    - Verify counts match what preview showed
    - Verify "No filters" appears for schedules without selectors

Expected behavior: Complete filter creation workflow works, preview is accurate, filters persist with schedules.
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Backend compiles: `go build ./...`
2. Frontend compiles: `cd web && npx tsc --noEmit`
3. Filter builder visible in ScheduleModal
4. Preview updates in real-time
5. Schedules page shows instance counts
6. Human verification of complete flow
</verification>

<success_criteria>
Phase 4 success criteria met:
1. User can create schedule filters based on instance name using regex patterns
2. User can create schedule filters based on instance tags using regex patterns
3. User can create schedule filters based on cloud provider (AWS/GCP)
4. User can combine filters with AND/OR operators
5. User can preview which instances will match a filter before applying
6. User can view all created schedules in a dedicated schedules tab (with instance counts)
</success_criteria>

<output>
After completion, create `.planning/phases/04-advanced-schedule-filtering/04-03-SUMMARY.md`
</output>
