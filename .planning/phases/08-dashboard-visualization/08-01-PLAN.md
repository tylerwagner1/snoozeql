---
phase: 08-dashboard-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/lib/api.ts
  - web/src/lib/formatters.ts
  - web/src/components/savings/DateRangeSelector.tsx
autonomous: true

must_haves:
  truths:
    - "API methods exist for fetching savings data with days parameter"
    - "Currency amounts display correctly as dollars with proper formatting"
    - "User can select between 7d, 30d, 90d date ranges"
  artifacts:
    - path: "web/src/lib/api.ts"
      provides: "Savings API types and methods"
      contains: "getSavingsSummary"
    - path: "web/src/lib/formatters.ts"
      provides: "Currency formatting utility"
      exports: ["formatCurrency"]
    - path: "web/src/components/savings/DateRangeSelector.tsx"
      provides: "Date range tab selector component"
      exports: ["DateRangeSelector"]
  key_links:
    - from: "api.ts"
      to: "Phase 7 backend"
      via: "HTTP GET requests"
      pattern: "/savings"
---

<objective>
Set up the foundation for the savings dashboard: API types, API methods, currency formatter, and date range selector component.

Purpose: Establish the data layer and shared components that all visualization components will use.
Output: Typed API methods for savings endpoints, formatCurrency helper, DateRangeSelector component.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dashboard-visualization/08-RESEARCH.md
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add savings API types and methods to api.ts</name>
  <files>web/src/lib/api.ts</files>
  <action>
Add the following TypeScript interfaces after the existing Stats interface:

```typescript
export interface SavingsSummary {
  total_savings_cents: number
  ongoing_savings_cents: number
  period: {
    start: string
    end: string
  }
  top_savers: Array<{
    instance_id: string
    savings_cents: number
    stopped_hours: number
  }>
}

export interface DailySavingsResponse {
  daily_savings: Array<{
    date: string
    savings_cents: number
    stopped_minutes: number
    hourly_rate_cents?: number
  }>
}

export interface InstanceSavingsItem {
  instance_id: string
  name: string
  provider: string
  region: string
  savings_cents: number
  stopped_hours: number
}

export interface InstanceSavingsDetail {
  instance_id: string
  total_savings_cents: number
  ongoing_savings_cents: number
  savings: Array<{
    date: string
    stopped_minutes: number
    savings_cents: number
    hourly_rate_cents: number
  }>
}
```

Add the following API methods to the api object, after the existing getEventsByInstance method:

```typescript
// Savings
getSavingsSummary: (days: number = 30) =>
  api.get<SavingsSummary>(`/savings?days=${days}`),

getDailySavings: (days: number = 30) =>
  api.get<DailySavingsResponse>(`/savings/daily?days=${days}`),

getSavingsByInstance: (days: number = 30, limit: number = 20) =>
  api.get<InstanceSavingsItem[]>(`/savings/by-instance?days=${days}&limit=${limit}`),

getInstanceSavings: (instanceId: string, days: number = 30) =>
  api.get<InstanceSavingsDetail>(`/instances/${instanceId}/savings?days=${days}`),
```

Also export the new types by adding them to the existing export pattern.
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm no TypeScript errors.</verify>
  <done>Four savings interfaces and four API methods are added to api.ts with proper typing.</done>
</task>

<task type="auto">
  <name>Task 2: Create formatters.ts with currency formatting</name>
  <files>web/src/lib/formatters.ts</files>
  <action>
Create a new file `web/src/lib/formatters.ts` with a formatCurrency function:

```typescript
/**
 * Format cents as a currency string (e.g., 152345 -> "$1,523.45")
 * Uses Intl.NumberFormat for proper locale handling
 */
export function formatCurrency(cents: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(cents / 100)
}

/**
 * Format a number of hours as a readable string (e.g., 24.5 -> "24.5h")
 */
export function formatHours(hours: number): string {
  return `${hours.toFixed(1)}h`
}
```

Why this approach:
- Intl.NumberFormat handles thousands separators, decimals, and currency symbols automatically
- Division by 100 converts cents to dollars at display time (keeps integer math elsewhere)
- Consistent formatting across all savings components
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm no TypeScript errors.</verify>
  <done>formatCurrency and formatHours functions exist in formatters.ts and compile without errors.</done>
</task>

<task type="auto">
  <name>Task 3: Create DateRangeSelector component</name>
  <files>web/src/components/savings/DateRangeSelector.tsx</files>
  <action>
Create directory `web/src/components/savings/` if it doesn't exist.

Create `web/src/components/savings/DateRangeSelector.tsx`:

```typescript
import clsx from 'clsx'

export type DateRange = '7d' | '30d' | '90d'

interface DateRangeSelectorProps {
  value: DateRange
  onChange: (value: DateRange) => void
}

const options: Array<{ value: DateRange; label: string }> = [
  { value: '7d', label: '7 days' },
  { value: '30d', label: '30 days' },
  { value: '90d', label: '90 days' },
]

export function DateRangeSelector({ value, onChange }: DateRangeSelectorProps) {
  return (
    <div className="flex items-center gap-1 bg-slate-800/50 rounded-lg p-1 border border-slate-700">
      {options.map((opt) => (
        <button
          key={opt.value}
          onClick={() => onChange(opt.value)}
          className={clsx(
            'px-4 py-2 text-sm font-medium rounded-md transition-all',
            value === opt.value
              ? 'bg-blue-600 text-white shadow-lg shadow-blue-500/20'
              : 'text-slate-400 hover:text-white hover:bg-slate-700'
          )}
        >
          {opt.label}
        </button>
      ))}
    </div>
  )
}
```

Why this design:
- Tab-style selector matches existing codebase UI patterns
- Uses clsx for conditional classes (already installed)
- Exports DateRange type for use in parent components
- Tailwind styling consistent with Dashboard.tsx card styling
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm component compiles without errors.</verify>
  <done>DateRangeSelector component exists with proper typing and Tailwind styling.</done>
</task>

</tasks>

<verification>
All three tasks complete when:
1. `cd web && npx tsc --noEmit` passes with no errors
2. api.ts contains SavingsSummary, DailySavingsResponse, InstanceSavingsItem, InstanceSavingsDetail types
3. api.ts contains getSavingsSummary, getDailySavings, getSavingsByInstance, getInstanceSavings methods
4. formatters.ts exists with formatCurrency and formatHours functions
5. DateRangeSelector.tsx exists in web/src/components/savings/
</verification>

<success_criteria>
- TypeScript compilation succeeds
- All four API types defined
- All four API methods defined
- formatCurrency correctly divides cents by 100
- DateRangeSelector component renders 3 tabs (7d, 30d, 90d)
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-visualization/08-01-SUMMARY.md`
</output>
