---
phase: 08-dashboard-visualization
plan: 04
type: execute
wave: 3
depends_on: ["08-02", "08-03"]
files_modified:
  - web/src/pages/SavingsPage.tsx
  - web/src/main.tsx
  - web/src/components/Navigation.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to /savings page via navigation menu"
    - "User can view time-series chart of savings over configurable ranges (7d, 30d, 90d)"
    - "User can see per-instance savings table showing which instances contributed most"
    - "User can compare actual costs vs projected 'always-on' costs"
    - "Dashboard displays summary cards with total savings"
  artifacts:
    - path: "web/src/pages/SavingsPage.tsx"
      provides: "Main savings dashboard page"
      exports: ["SavingsPage"]
      min_lines: 80
    - path: "web/src/main.tsx"
      provides: "Route registration"
      contains: "/savings"
    - path: "web/src/components/Navigation.tsx"
      provides: "Navigation link"
      contains: "Savings"
  key_links:
    - from: "SavingsPage.tsx"
      to: "/api/v1/savings"
      via: "api.getSavingsSummary"
      pattern: "getSavingsSummary"
    - from: "SavingsPage.tsx"
      to: "savings components"
      via: "import"
      pattern: "SavingsSummaryCards.*SavingsChart.*InstanceSavingsTable.*CostProjection"
    - from: "main.tsx"
      to: "SavingsPage"
      via: "Route element"
      pattern: "path=\"savings\""
    - from: "Navigation.tsx"
      to: "/savings"
      via: "Link"
      pattern: "to=\"/savings\""
---

<objective>
Create the SavingsPage that assembles all components, add route registration, and add navigation link. Includes visual verification checkpoint.

Purpose: Complete the savings dashboard by wiring components together and making it accessible via the app navigation.
Output: Working /savings page with all visualization components, accessible from main navigation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dashboard-visualization/08-RESEARCH.md
@web/src/pages/Dashboard.tsx
@web/src/main.tsx
@web/src/components/Navigation.tsx
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SavingsPage with all components</name>
  <files>web/src/pages/SavingsPage.tsx</files>
  <action>
Create `web/src/pages/SavingsPage.tsx`:

```typescript
import { useState, useEffect } from 'react'
import api from '../lib/api'
import type { SavingsSummary, InstanceSavingsItem } from '../lib/api'
import { DateRangeSelector, DateRange } from '../components/savings/DateRangeSelector'
import { SavingsSummaryCards } from '../components/savings/SavingsSummaryCards'
import { SavingsChart } from '../components/savings/SavingsChart'
import { InstanceSavingsTable } from '../components/savings/InstanceSavingsTable'
import { CostProjection } from '../components/savings/CostProjection'

interface DailySavings {
  date: string
  savings_cents: number
  stopped_minutes: number
}

export default function SavingsPage() {
  const [dateRange, setDateRange] = useState<DateRange>('30d')
  const [loading, setLoading] = useState(true)
  const [summary, setSummary] = useState<SavingsSummary | null>(null)
  const [dailySavings, setDailySavings] = useState<DailySavings[]>([])
  const [instanceSavings, setInstanceSavings] = useState<InstanceSavingsItem[]>([])

  useEffect(() => {
    const fetchData = async () => {
      setLoading(true)
      try {
        const days = dateRange === '7d' ? 7 : dateRange === '30d' ? 30 : 90

        const [summaryData, dailyData, byInstanceData] = await Promise.all([
          api.getSavingsSummary(days),
          api.getDailySavings(days),
          api.getSavingsByInstance(days, 10),
        ])

        setSummary(summaryData)
        setDailySavings(dailyData.daily_savings || [])
        setInstanceSavings(byInstanceData || [])
      } catch (err) {
        console.error('Failed to fetch savings data:', err)
        // Keep previous data on error to avoid flicker
      } finally {
        setLoading(false)
      }
    }

    fetchData()
  }, [dateRange])

  // Calculate projection data from summary
  // Projected cost = actual cost + savings (what we would have paid without SnoozeQL)
  const actualCostCents = summary
    ? summary.total_savings_cents // This is what we saved, not what we paid
    : 0
  // For now, show savings as the "actual" and 2x savings as "projected"
  // In a real implementation, this would come from billing data
  const projectedAlwaysOnCents = actualCostCents * 2

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div>
          <h1 className="text-3xl font-bold text-white">Cost Savings</h1>
          <p className="text-sm text-slate-400 mt-1">
            Track your database cost optimization with SnoozeQL
          </p>
        </div>
        <DateRangeSelector value={dateRange} onChange={setDateRange} />
      </div>

      {/* Summary Cards */}
      <SavingsSummaryCards data={summary} loading={loading} />

      {/* Savings Chart */}
      <SavingsChart data={dailySavings} loading={loading} />

      {/* Two-column layout for table and projection on larger screens */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Instance Savings Table */}
        <InstanceSavingsTable data={instanceSavings} loading={loading} />

        {/* Cost Projection */}
        <CostProjection
          actualCostCents={actualCostCents}
          projectedAlwaysOnCents={projectedAlwaysOnCents}
          loading={loading}
        />
      </div>
    </div>
  )
}
```

Why this design:
- Page-level data fetching pattern matches Dashboard.tsx
- Parallel API calls with Promise.all for performance
- Date range change triggers refetch
- Error handling preserves previous data to avoid UI flicker
- Responsive two-column layout for table and projection
- All Phase 8 success criteria components are included
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm page compiles.</verify>
  <done>SavingsPage exists with all four visualization components and date range selector.</done>
</task>

<task type="auto">
  <name>Task 2: Register route and add navigation link</name>
  <files>web/src/main.tsx, web/src/components/Navigation.tsx</files>
  <action>
**Update web/src/main.tsx:**

Add import for SavingsPage after the existing page imports:
```typescript
import SavingsPage from './pages/SavingsPage'
```

Add route inside the `<Route path="/" element={<App />}>` block, after the audit-log route:
```typescript
<Route path="savings" element={<SavingsPage />} />
```

**Update web/src/components/Navigation.tsx:**

Add import for PiggyBank icon (or use DollarSign if preferred) at the top:
```typescript
import { Activity, Database, Clock, Lightbulb, Cloud, FileText, PiggyBank } from 'lucide-react'
```

Add Savings link after the Recommendations link and before the Audit Log link:
```typescript
<Link to="/savings" className="flex items-center space-x-1.5 px-3 py-1.5 text-sm font-medium rounded-full transition-all duration-200 hover:bg-green-500/20 hover:text-green-400 text-slate-300">
  <PiggyBank className="h-4 w-4" />
  <span className="hidden sm:inline">Savings</span>
</Link>
```

Note: Position the Savings link to be visible and use green hover color to indicate savings/money theme.
  </action>
  <verify>Run `cd web && npm run build` to confirm the build succeeds with new route.</verify>
  <done>Route /savings is registered in main.tsx and Navigation has "Savings" link with PiggyBank icon.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete savings dashboard with:
- Summary cards showing total savings, ongoing savings, and top savers count
- Time-series area chart with daily savings over selected date range (7d/30d/90d)
- Per-instance savings attribution table with ranked instances
- Cost projection comparison with SAV-05 disclaimer
- Navigation link to /savings page
  </what-built>
  <how-to-verify>
1. Start the dev server: `cd web && npm run dev`
2. Start the backend: `go run ./cmd/server` (in a separate terminal)
3. Open http://localhost:5173/savings in your browser
4. Verify you see:
   - Page title "Cost Savings" with date range selector (7 days, 30 days, 90 days tabs)
   - Three summary cards (Total Savings, Ongoing Savings, Top Savers)
   - Area chart showing "Savings Over Time" (may be empty if no savings data)
   - Table showing "Top Saving Instances" (may show empty state)
   - Cost comparison section with "If Always Running" vs "Actual Cost"
   - Yellow disclaimer box with warning icon about estimates
5. Click the date range tabs - verify data refreshes
6. Verify "Savings" link appears in navigation bar with green hover effect
7. Click navigation link - verify it navigates to /savings

Expected behavior for new/empty data:
- Empty states should show helpful messages like "No savings data yet"
- No errors in browser console
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
All tasks complete when:
1. `cd web && npm run build` succeeds
2. SavingsPage.tsx exists and imports all four visualization components
3. main.tsx has route for /savings
4. Navigation.tsx has "Savings" link with PiggyBank icon
5. Human verification confirms visual correctness
</verification>

<success_criteria>
Phase 8 Success Criteria (from roadmap):
1. User can view time-series chart of savings over configurable ranges (7d, 30d, 90d) ✓
2. User can see per-instance savings table showing which instances contributed most ✓
3. User can compare actual costs vs projected "always-on" costs with clear disclaimers ✓
4. Dashboard displays summary cards with total savings ✓

Requirements satisfied:
- SAV-03: Historical activity charts with configurable time ranges ✓
- SAV-04: Per-instance savings attribution ✓
- SAV-05: Cost projection with disclaimers ✓
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-visualization/08-04-SUMMARY.md`
</output>
