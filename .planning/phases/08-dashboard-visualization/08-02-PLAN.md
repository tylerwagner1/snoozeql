---
phase: 08-dashboard-visualization
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - web/src/components/savings/SavingsSummaryCards.tsx
  - web/src/components/savings/SavingsChart.tsx
  - web/src/components/savings/InstanceSavingsTable.tsx
autonomous: true

must_haves:
  truths:
    - "User can see summary cards with total savings, ongoing savings, and trend indicator"
    - "User can view time-series chart showing daily savings over selected period"
    - "User can see per-instance savings table sorted by contribution"
  artifacts:
    - path: "web/src/components/savings/SavingsSummaryCards.tsx"
      provides: "Summary stat cards with icons"
      exports: ["SavingsSummaryCards"]
    - path: "web/src/components/savings/SavingsChart.tsx"
      provides: "Time-series area chart with Recharts"
      exports: ["SavingsChart"]
    - path: "web/src/components/savings/InstanceSavingsTable.tsx"
      provides: "Per-instance attribution table"
      exports: ["InstanceSavingsTable"]
  key_links:
    - from: "SavingsSummaryCards.tsx"
      to: "formatters.ts"
      via: "import"
      pattern: "formatCurrency"
    - from: "SavingsChart.tsx"
      to: "recharts"
      via: "import"
      pattern: "AreaChart.*ResponsiveContainer"
    - from: "InstanceSavingsTable.tsx"
      to: "formatters.ts"
      via: "import"
      pattern: "formatCurrency"
---

<objective>
Create the three main visualization components for the savings dashboard: summary cards, time-series chart, and instance attribution table.

Purpose: Build the core UI components that display savings data from the Phase 7 API endpoints.
Output: SavingsSummaryCards, SavingsChart, InstanceSavingsTable components ready for page integration.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-dashboard-visualization/08-RESEARCH.md
@web/src/lib/api.ts
@web/src/lib/formatters.ts
@web/src/components/ActivityGraph.tsx
@web/src/pages/Dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SavingsSummaryCards component</name>
  <files>web/src/components/savings/SavingsSummaryCards.tsx</files>
  <action>
Create `web/src/components/savings/SavingsSummaryCards.tsx`:

```typescript
import { TrendingDown, Clock, DollarSign } from 'lucide-react'
import { formatCurrency } from '../../lib/formatters'
import type { SavingsSummary } from '../../lib/api'

interface SavingsSummaryCardsProps {
  data: SavingsSummary | null
  loading: boolean
}

export function SavingsSummaryCards({ data, loading }: SavingsSummaryCardsProps) {
  if (loading) {
    return (
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        {[1, 2, 3].map((i) => (
          <div key={i} className="bg-slate-800/50 rounded-xl p-5 border border-slate-700 animate-pulse">
            <div className="h-4 bg-slate-700 rounded w-24 mb-3" />
            <div className="h-8 bg-slate-700 rounded w-32 mb-2" />
            <div className="h-3 bg-slate-700 rounded w-20" />
          </div>
        ))}
      </div>
    )
  }

  if (!data) {
    return null
  }

  const cards = [
    {
      title: 'Total Savings',
      value: formatCurrency(data.total_savings_cents),
      subtitle: `${data.period.start} - ${data.period.end}`,
      icon: TrendingDown,
      gradient: 'from-green-500 to-emerald-600',
      shadow: 'shadow-green-500/20',
      hoverBorder: 'hover:border-green-500/50',
      subtitleColor: 'text-green-400',
    },
    {
      title: 'Ongoing Savings',
      value: formatCurrency(data.ongoing_savings_cents),
      subtitle: 'Currently accumulating',
      icon: Clock,
      gradient: 'from-blue-500 to-indigo-600',
      shadow: 'shadow-blue-500/20',
      hoverBorder: 'hover:border-blue-500/50',
      subtitleColor: 'text-blue-400',
    },
    {
      title: 'Top Savers',
      value: data.top_savers.length > 0 ? data.top_savers.length.toString() : '0',
      subtitle: data.top_savers.length > 0 
        ? `Best: ${formatCurrency(data.top_savers[0]?.savings_cents || 0)}`
        : 'No savings yet',
      icon: DollarSign,
      gradient: 'from-purple-500 to-pink-600',
      shadow: 'shadow-purple-500/20',
      hoverBorder: 'hover:border-purple-500/50',
      subtitleColor: 'text-purple-400',
    },
  ]

  return (
    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
      {cards.map((card) => (
        <div
          key={card.title}
          className={`bg-slate-800/50 rounded-xl p-5 shadow-lg border border-slate-700 ${card.hoverBorder} transition-all group`}
        >
          <div className="flex items-center justify-between mb-3">
            <p className="text-sm text-slate-400 font-medium">{card.title}</p>
            <div className={`p-2 bg-gradient-to-br ${card.gradient} rounded-lg group-hover:scale-105 transition-transform shadow-lg ${card.shadow}`}>
              <card.icon className="h-5 w-5 text-white" />
            </div>
          </div>
          <p className="text-3xl font-bold text-white mb-1">{card.value}</p>
          <p className={`text-sm ${card.subtitleColor}`}>{card.subtitle}</p>
        </div>
      ))}
    </div>
  )
}
```

Why this design:
- Matches Dashboard.tsx summary card styling exactly
- Loading skeleton prevents layout shift
- Graceful handling of null/empty data
- Dynamic card configuration array for maintainability
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm component compiles.</verify>
  <done>SavingsSummaryCards component renders 3 cards with proper styling and loading state.</done>
</task>

<task type="auto">
  <name>Task 2: Create SavingsChart component</name>
  <files>web/src/components/savings/SavingsChart.tsx</files>
  <action>
Create `web/src/components/savings/SavingsChart.tsx`:

```typescript
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
} from 'recharts'
import { formatCurrency } from '../../lib/formatters'

interface DailySavings {
  date: string
  savings_cents: number
  stopped_minutes: number
}

interface SavingsChartProps {
  data: DailySavings[]
  loading: boolean
}

export function SavingsChart({ data, loading }: SavingsChartProps) {
  if (loading) {
    return (
      <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
        <div className="h-4 bg-slate-700 rounded w-40 mb-4 animate-pulse" />
        <div className="h-64 bg-slate-700/50 rounded animate-pulse" />
      </div>
    )
  }

  if (data.length === 0) {
    return (
      <div className="bg-slate-800/50 rounded-xl p-8 border border-slate-700 text-center">
        <p className="text-slate-400">No savings data yet.</p>
        <p className="text-sm text-slate-500 mt-2">
          Savings are calculated when instances are stopped via schedules or manual actions.
        </p>
      </div>
    )
  }

  // Transform cents to dollars for display
  const chartData = data.map((d) => ({
    date: formatDate(d.date),
    savings: d.savings_cents / 100,
    savingsCents: d.savings_cents,
    stoppedHours: Math.round(d.stopped_minutes / 60 * 10) / 10,
  }))

  return (
    <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
      <h2 className="text-lg font-semibold text-white mb-4">Savings Over Time</h2>
      <div className="h-64">
        <ResponsiveContainer>
          <AreaChart data={chartData} margin={{ top: 10, right: 10, left: 0, bottom: 0 }}>
            <defs>
              <linearGradient id="savingsGradient" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stopColor="#10b981" stopOpacity={0.3} />
                <stop offset="100%" stopColor="#10b981" stopOpacity={0} />
              </linearGradient>
            </defs>
            <CartesianGrid vertical={false} stroke="#334155" strokeOpacity={0.2} />
            <XAxis
              dataKey="date"
              tick={{ fill: '#94a3b8', fontSize: 10 }}
              tickLine={false}
              axisLine={false}
              interval="preserveStartEnd"
            />
            <YAxis
              tick={{ fill: '#94a3b8', fontSize: 10 }}
              tickLine={false}
              axisLine={false}
              tickFormatter={(v) => `$${v}`}
              width={50}
            />
            <Tooltip
              contentStyle={{
                background: '#1e293b',
                border: '1px solid #334155',
                borderRadius: '0.5rem',
              }}
              labelStyle={{ color: '#f8fafc', marginBottom: '0.5rem' }}
              formatter={(value: number, name: string) => {
                if (name === 'savings') {
                  return [formatCurrency(value * 100), 'Savings']
                }
                return [value, name]
              }}
            />
            <Area
              type="monotone"
              dataKey="savings"
              stroke="#10b981"
              fill="url(#savingsGradient)"
              strokeWidth={2}
            />
          </AreaChart>
        </ResponsiveContainer>
      </div>
    </div>
  )
}

function formatDate(dateString: string): string {
  const date = new Date(dateString)
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}
```

Why this design:
- Follows ActivityGraph.tsx Recharts patterns exactly
- Empty state explains how savings work (for new users)
- Loading skeleton matches card height
- Custom tooltip formatter converts back to currency format
- Green gradient matches savings theme
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm component compiles.</verify>
  <done>SavingsChart component renders area chart with proper Recharts configuration and empty/loading states.</done>
</task>

<task type="auto">
  <name>Task 3: Create InstanceSavingsTable component</name>
  <files>web/src/components/savings/InstanceSavingsTable.tsx</files>
  <action>
Create `web/src/components/savings/InstanceSavingsTable.tsx`:

```typescript
import { formatCurrency, formatHours } from '../../lib/formatters'
import type { InstanceSavingsItem } from '../../lib/api'

interface InstanceSavingsTableProps {
  data: InstanceSavingsItem[]
  loading: boolean
}

export function InstanceSavingsTable({ data, loading }: InstanceSavingsTableProps) {
  if (loading) {
    return (
      <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
        <div className="h-4 bg-slate-700 rounded w-48 mb-4 animate-pulse" />
        <div className="space-y-3">
          {[1, 2, 3, 4, 5].map((i) => (
            <div key={i} className="h-12 bg-slate-700/50 rounded animate-pulse" />
          ))}
        </div>
      </div>
    )
  }

  if (data.length === 0) {
    return (
      <div className="bg-slate-800/50 rounded-xl p-8 border border-slate-700 text-center">
        <p className="text-slate-400">No instance savings data yet.</p>
        <p className="text-sm text-slate-500 mt-2">
          Stop instances to start accumulating savings.
        </p>
      </div>
    )
  }

  return (
    <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
      <h2 className="text-lg font-semibold text-white mb-4">Top Saving Instances</h2>
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead>
            <tr className="text-left text-sm text-slate-400 border-b border-slate-700">
              <th className="pb-3 font-medium">Instance</th>
              <th className="pb-3 font-medium">Provider</th>
              <th className="pb-3 font-medium">Region</th>
              <th className="pb-3 font-medium text-right">Hours Stopped</th>
              <th className="pb-3 font-medium text-right">Savings</th>
            </tr>
          </thead>
          <tbody>
            {data.map((instance, index) => (
              <tr
                key={instance.instance_id}
                className="border-b border-slate-700/50 hover:bg-slate-700/30 transition-colors"
              >
                <td className="py-3 text-sm">
                  <div className="flex items-center gap-2">
                    <span className="text-slate-500 text-xs w-5">#{index + 1}</span>
                    <span className="text-white font-medium">{instance.name}</span>
                  </div>
                </td>
                <td className="py-3 text-sm text-slate-300">
                  <span className="px-2 py-0.5 bg-slate-700 rounded text-xs uppercase">
                    {instance.provider}
                  </span>
                </td>
                <td className="py-3 text-sm text-slate-300">{instance.region}</td>
                <td className="py-3 text-sm text-slate-300 text-right">
                  {formatHours(instance.stopped_hours)}
                </td>
                <td className="py-3 text-sm text-green-400 text-right font-medium">
                  {formatCurrency(instance.savings_cents)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  )
}
```

Why this design:
- Table styling matches existing codebase patterns
- Rank indicator (#1, #2, etc.) makes attribution clear (SAV-04)
- Provider badge uses same styling as instances table
- Loading skeleton shows expected row count
- Empty state guides user on how to generate data
  </action>
  <verify>Run `cd web && npx tsc --noEmit` to confirm component compiles.</verify>
  <done>InstanceSavingsTable component renders sortable table with loading and empty states.</done>
</task>

</tasks>

<verification>
All three tasks complete when:
1. `cd web && npx tsc --noEmit` passes with no errors
2. SavingsSummaryCards.tsx exists with proper imports from formatters.ts and api.ts
3. SavingsChart.tsx exists with Recharts AreaChart configuration
4. InstanceSavingsTable.tsx exists with table rendering logic
5. All components handle loading and empty states gracefully
</verification>

<success_criteria>
- TypeScript compilation succeeds
- SavingsSummaryCards shows 3 cards with icons and values
- SavingsChart displays area chart with green gradient
- InstanceSavingsTable shows ranked rows with savings amounts
- All components have loading skeleton and empty state
</success_criteria>

<output>
After completion, create `.planning/phases/08-dashboard-visualization/08-02-SUMMARY.md`
</output>
