---
phase: 14-grouped-recommendations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/api/handlers/recommendations.go
autonomous: true

must_haves:
  truths:
    - "API returns recommendations organized into pattern groups"
    - "Each group has pattern_description, total_daily_savings, instance_count"
    - "Groups are sorted by total savings descending"
    - "Recommendations within groups are sorted by individual savings descending"
  artifacts:
    - path: "internal/api/handlers/recommendations.go"
      provides: "Pattern grouping logic"
      contains: "groupRecommendations"
  key_links:
    - from: "GetAllRecommendations"
      to: "groupRecommendations"
      via: "function call after enrichment"
      pattern: "groupRecommendations\\(enriched\\)"
---

<objective>
Add pattern signature generation and grouping logic to recommendations API

Purpose: Enable frontend to display recommendations grouped by similar idle patterns (REC-02)
Output: Modified GetAllRecommendations endpoint returning grouped response structure
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-grouped-recommendations/14-RESEARCH.md

@internal/api/handlers/recommendations.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pattern signature and grouping functions</name>
  <files>internal/api/handlers/recommendations.go</files>
  <action>
Add the following to recommendations.go:

1. Add PatternSignature struct:
```go
type PatternSignature struct {
    StartBucket string
    EndBucket   string
    DayType     string
}
```

2. Add RecommendationGroup struct:
```go
type RecommendationGroup struct {
    PatternDescription   string        `json:"pattern_description"`
    PatternKey           string        `json:"pattern_key"`
    TotalDailySavings    float64       `json:"total_daily_savings"`
    InstanceCount        int           `json:"instance_count"`
    Recommendations      []enrichedRec `json:"recommendations"`
}
```

3. Add helper functions:
- `hourToBucket(hour int) string` - Maps hours to buckets: "early-morning" (6-10), "midday" (10-14), "afternoon" (14-18), "evening" (18-22), "night" (22-6)
- `daysToType(days []interface{}) string` - Returns "daily" (7 days), "weekdays" (4+ weekdays, 0 weekends), "weekends" (2+ weekends, 0 weekdays), "mixed" (else)
- `generatePatternSignature(pattern map[string]interface{}) PatternSignature` - Creates signature from detected_pattern
- `formatHour(hour int) string` - Format hour as "6am", "noon", "midnight", "10pm" etc.
- `describePattern(pattern map[string]interface{}) string` - Returns human-readable description like "Idle 10pm to 6am, weekdays"
- `groupRecommendations(recs []enrichedRec) []RecommendationGroup` - Groups by pattern signature, sorts by total savings

Reference RESEARCH.md for exact implementation details.
  </action>
  <verify>File compiles: `cd internal/api/handlers && go build .`</verify>
  <done>Pattern signature and grouping functions exist and compile</done>
</task>

<task type="auto">
  <name>Task 2: Modify GetAllRecommendations to return grouped response</name>
  <files>internal/api/handlers/recommendations.go</files>
  <action>
Modify GetAllRecommendations to use grouping:

1. After enriching recommendations (the existing for loop that builds `enriched` slice), add:
```go
// Group recommendations by pattern signature
groups := groupRecommendations(enriched)
```

2. Change the response encoding from `json.NewEncoder(w).Encode(enriched)` to:
```go
json.NewEncoder(w).Encode(map[string]interface{}{
    "groups": groups,
})
```

This wraps the response in an object with a "groups" key containing the array of RecommendationGroup objects.

IMPORTANT: Keep the existing enrichment logic intact. The grouping happens AFTER enrichment.
  </action>
  <verify>
Run backend and test:
```bash
# Start backend if not running
curl -H "Authorization: Bearer dev-key" http://localhost:8080/api/v1/recommendations | jq '.groups[0]'
```
Should return a group object with pattern_description, total_daily_savings, instance_count, and recommendations array.
  </verify>
  <done>GetAllRecommendations returns { groups: [...] } structure with grouped recommendations</done>
</task>

</tasks>

<verification>
1. Backend compiles: `go build ./...`
2. API returns grouped structure: `curl -H "Authorization: Bearer dev-key" http://localhost:8080/api/v1/recommendations | jq '.groups'`
3. Each group has required fields: pattern_description, pattern_key, total_daily_savings, instance_count, recommendations
4. Groups sorted by total_daily_savings descending
5. Recommendations within groups sorted by estimated_daily_savings descending
</verification>

<success_criteria>
- REC-02 backend complete: API returns recommendations grouped by similar idle patterns
- Response structure: { groups: [{ pattern_description, pattern_key, total_daily_savings, instance_count, recommendations: [...] }] }
- Grouping uses pattern signatures (start bucket, end bucket, day type)
- Human-readable pattern descriptions (e.g., "Idle 10pm to 6am, weekdays")
</success_criteria>

<output>
After completion, create `.planning/phases/14-grouped-recommendations/14-01-SUMMARY.md`
</output>
