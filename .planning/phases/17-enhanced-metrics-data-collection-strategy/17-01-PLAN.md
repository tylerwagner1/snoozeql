---
phase: 17-enhanced-metrics-data-collection-strategy
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/metrics/cloudwatch.go
  - internal/metrics/collector.go
  - internal/metrics/store.go
autonomous: true

must_haves:
  truths:
    - "CloudWatch API called with Period=300 (5 minutes) instead of Period=3600"
    - "Collection cycle fetches 3 datapoints per 15-minute interval"
    - "Metrics stored with 5-minute granularity timestamps"
  artifacts:
    - path: "internal/metrics/cloudwatch.go"
      provides: "GetRDSMetricsMultiple method returning []RDSMetricDatapoint"
      contains: "Period.*300"
    - path: "internal/metrics/collector.go"
      provides: "Updated collectInstance to process multiple datapoints"
      contains: "GetRDSMetricsMultiple"
    - path: "internal/metrics/store.go"
      provides: "5-minute truncation constant"
      contains: "MetricPeriod"
  key_links:
    - from: "collector.go"
      to: "cloudwatch.go"
      via: "GetRDSMetricsMultiple call"
      pattern: "client\\.GetRDSMetricsMultiple"
    - from: "collector.go"
      to: "store.go"
      via: "UpsertHourlyMetric for each datapoint"
      pattern: "storeMetric.*MetricPeriod"
---

<objective>
Change CloudWatch collection from hourly (Period=3600) to 5-minute intervals (Period=300) and fetch 3 datapoints per 15-minute collection cycle.

Purpose: Higher granularity metrics enable better idle detection and visualization
Output: CloudWatch client fetches 3 datapoints per cycle, stored with 5-minute timestamps
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-enhanced-metrics-data-collection-strategy/17-RESEARCH.md

@internal/metrics/cloudwatch.go
@internal/metrics/collector.go
@internal/metrics/store.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MetricPeriod constant and update truncation in store.go</name>
  <files>internal/metrics/store.go</files>
  <action>
Add a constant at the top of store.go:

```go
const MetricPeriod = 5 * time.Minute
```

Update `UpsertHourlyMetric` to use 5-minute truncation instead of hourly:
- Change `date_trunc('hour', $3::timestamptz)` to use a time interval that truncates to 5 minutes
- PostgreSQL approach: `date_trunc('hour', $3::timestamptz) + (EXTRACT(MINUTE FROM $3::timestamptz)::int / 5 * interval '5 minutes')`
- Alternatively, handle truncation in Go before passing to query: `hour.Truncate(MetricPeriod)`

Simpler approach (recommended): Truncate in Go before passing to query:
- The caller (storeMetric in collector.go) should pass already-truncated timestamps
- Keep the SQL as-is but document that timestamps should be pre-truncated to 5 minutes
- Add helper: `func TruncateToMetricPeriod(t time.Time) time.Time { return t.Truncate(MetricPeriod) }`

Also update `HourHasData` to truncate to 5 minutes instead of hour.
  </action>
  <verify>
Run `go build ./...` - no compilation errors
Grep for MetricPeriod in store.go to confirm constant exists
  </verify>
  <done>
MetricPeriod constant (5 minutes) defined and truncation helper added
UpsertHourlyMetric and HourHasData work with 5-minute granularity
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GetRDSMetricsMultiple to cloudwatch.go</name>
  <files>internal/metrics/cloudwatch.go</files>
  <action>
Add new types and method to cloudwatch.go:

1. Add `RDSMetricDatapoint` struct:
```go
// RDSMetricDatapoint holds metrics for a single 5-minute interval
type RDSMetricDatapoint struct {
    Timestamp   time.Time
    CPU         *MetricValue
    Connections *MetricValue
    ReadIOPS    *MetricValue
    WriteIOPS   *MetricValue
    FreeMemory  *MetricValue
}
```

2. Add `GetRDSMetricsMultiple` method that:
   - Takes `ctx`, `dbInstanceID`, `start`, `end` time.Time parameters
   - Calls each metric with Period=300 (not 3600)
   - Returns `[]RDSMetricDatapoint` organized by timestamp
   - Each call returns up to 3 datapoints (for 15-min window)

Implementation approach:
- Create a helper `getMetricMultiple` that returns all datapoints (not just most recent)
- Fetch each metric type separately (CPU, Connections, FreeableMemory, etc.)
- Merge datapoints by timestamp into RDSMetricDatapoint slice
- Sort by timestamp ascending

Do NOT modify existing `getMetric` or `GetRDSMetrics` - add new methods alongside.
Keep existing methods for backward compatibility with BackfillMetrics.
  </action>
  <verify>
Run `go build ./...` - no compilation errors
Grep for "GetRDSMetricsMultiple" to confirm method exists
Grep for "Period.*300" to confirm 5-minute period in new method
  </verify>
  <done>
GetRDSMetricsMultiple method returns slice of datapoints with 5-minute granularity
Method fetches all datapoints in window, not just most recent
  </done>
</task>

<task type="auto">
  <name>Task 3: Update collector to use multi-datapoint collection</name>
  <files>internal/metrics/collector.go</files>
  <action>
Update `collectInstance` method to:

1. Call `GetRDSMetricsMultiple` instead of `GetRDSMetrics`:
   - Calculate start as `now.Add(-15 * time.Minute)` 
   - Calculate end as `now`
   - This captures 3 datapoints (one per 5-minute interval)

2. Loop through returned datapoints and store each:
   - For each `RDSMetricDatapoint` in the slice
   - Call `storeMetric` with the datapoint's timestamp (already 5-minute aligned from CloudWatch)
   - Store CPU, Connections, FreeMemory as before

3. Update `storeZeroMetrics` to:
   - Generate 3 zero entries (for current 15-min window)
   - Use timestamps at 5-minute intervals: `now.Truncate(5*time.Minute)`, `-.5min`, `-.10min`

4. Import `MetricPeriod` constant from store (or define locally if cleaner)

Keep fallback behavior: if GetRDSMetricsMultiple fails, call storeZeroMetrics.
  </action>
  <verify>
Run `go build ./...` - no compilation errors
Grep for "GetRDSMetricsMultiple" in collector.go to confirm it's called
Log output should show "Starting metrics collection cycle" without errors
  </verify>
  <done>
collectInstance fetches 3 datapoints per cycle via GetRDSMetricsMultiple
Each datapoint stored with its CloudWatch-provided 5-minute timestamp
Zero metrics stored for 3 intervals when instance is stopped
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `go build ./...` passes with no errors
2. `grep -r "MetricPeriod" internal/metrics/` shows constant in store.go
3. `grep -r "GetRDSMetricsMultiple" internal/metrics/` shows method in cloudwatch.go and call in collector.go
4. `grep -r "Period.*300" internal/metrics/cloudwatch.go` shows 5-minute period
</verification>

<success_criteria>
- CloudWatch client has new GetRDSMetricsMultiple method returning []RDSMetricDatapoint
- Period changed from 3600 to 300 in new method
- Collector calls GetRDSMetricsMultiple and stores 3 datapoints per cycle
- MetricPeriod constant (5 minutes) used consistently for timestamp truncation
- All existing tests pass, no build errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-enhanced-metrics-data-collection-strategy/17-01-SUMMARY.md`
</output>
