---
phase: 03-basic-scheduling
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - web/src/pages/SchedulesPage.tsx
  - web/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can click 'Create Schedule' and see the modal"
    - "User can paint sleep hours on the grid in the modal"
    - "User can submit and see new schedule in the list"
    - "Schedule list shows active days and sleep hours summary"
    - "Edit button opens modal with pre-populated data"
    - "Empty state shows CTA to create first schedule"
  artifacts:
    - path: "web/src/pages/SchedulesPage.tsx"
      provides: "Updated schedules list with modal integration"
      min_lines: 150
  key_links:
    - from: "web/src/pages/SchedulesPage.tsx"
      to: "web/src/components/ScheduleModal.tsx"
      via: "import { ScheduleModal }"
      pattern: "ScheduleModal"
    - from: "web/src/pages/SchedulesPage.tsx"
      to: "web/src/lib/cronUtils.ts"
      via: "formatGridSummary or cronToGrid"
      pattern: "formatGridSummary|cronToGrid"
---

<objective>
Integrate ScheduleModal into SchedulesPage and update the list display.

Purpose: Replace the page-based schedule creation with modal-based flow, update the schedule list table to show better summaries (active days, sleep hours), and add proper empty state.

Output: Updated SchedulesPage that uses ScheduleModal for create/edit operations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-basic-scheduling/03-CONTEXT.md
@web/src/pages/SchedulesPage.tsx
@web/src/components/ScheduleModal.tsx
@web/src/lib/cronUtils.ts
@web/src/lib/api.ts
@web/src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update SchedulesPage with modal integration</name>
  <files>web/src/pages/SchedulesPage.tsx</files>
  <action>
Update `web/src/pages/SchedulesPage.tsx` to use ScheduleModal instead of navigating to /schedules/new:

**New imports:**
```typescript
import { ScheduleModal } from '../components/ScheduleModal'
import { cronToGrid, formatGridSummary } from '../lib/cronUtils'
```

**New state:**
```typescript
const [isModalOpen, setIsModalOpen] = useState(false)
const [editingSchedule, setEditingSchedule] = useState<Schedule | null>(null)
```

**Update handleCreateSchedule:**
```typescript
const handleCreateSchedule = () => {
  setEditingSchedule(null)  // Create mode
  setIsModalOpen(true)
}
```

**Add handleEditSchedule:**
```typescript
const handleEditSchedule = (schedule: Schedule) => {
  setEditingSchedule(schedule)
  setIsModalOpen(true)
}
```

**Add handleModalSuccess:**
```typescript
const handleModalSuccess = async () => {
  // Refresh schedules list after create/update
  const data = await api.getSchedules()
  const schedules = Array.isArray(data) ? data : []
  const safeSchedules = schedules.map(sched => ({
    ...sched,
    selectors: sched.selectors || []
  }))
  setSchedules(safeSchedules)
}
```

**Update table columns:**
Replace current columns with:
1. **Name** - Keep current design (icon + name + description)
2. **Active Days** - Show formatted active days summary (e.g., "Mon-Fri", "Weekdays")
3. **Sleep Hours** - Show formatted sleep hours (e.g., "10pm-6am")
4. **Status** - Keep enable/disable toggle
5. **Actions** - Edit and Delete buttons

**Compute summaries for display:**
For each schedule in the table, compute summary using cronToGrid and formatGridSummary:
```typescript
const getSummary = (schedule: Schedule) => {
  try {
    const grid = cronToGrid(schedule.sleep_cron, schedule.wake_cron)
    return formatGridSummary(grid)
  } catch {
    return { activeDays: schedule.sleep_cron, sleepHours: 'Custom CRON' }
  }
}
```

**Update Edit button:**
Change from `<Link to={...}>` to:
```typescript
<button onClick={() => handleEditSchedule(schedule)}>Edit</button>
```

**Update empty state:**
```tsx
{schedules.length === 0 && (
  <div className="p-12 text-center">
    <div className="inline-block p-4 bg-slate-700/50 rounded-full mb-4">
      <Clock className="h-12 w-12 text-slate-500" />
    </div>
    <p className="text-lg font-medium text-slate-300">No schedules yet</p>
    <p className="text-sm text-slate-400 mt-2 mb-6">
      Create your first schedule to start saving on database costs
    </p>
    <button
      onClick={handleCreateSchedule}
      className="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg font-medium hover:from-blue-500 hover:to-blue-600 shadow-lg shadow-blue-500/20"
    >
      Create your first schedule
    </button>
  </div>
)}
```

**Add modal at end of component:**
```tsx
<ScheduleModal
  isOpen={isModalOpen}
  onClose={() => setIsModalOpen(false)}
  onSuccess={handleModalSuccess}
  schedule={editingSchedule}
/>
```

**Remove navigation import** if no longer used (useNavigate).
  </action>
  <verify>
TypeScript compiles: `cd web && npx tsc --noEmit`
  </verify>
  <done>
- SchedulesPage uses ScheduleModal for create/edit
- "Create Schedule" button opens modal
- Edit button opens modal with schedule data
- Table shows Active Days and Sleep Hours summaries
- Empty state shows CTA button that opens modal
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Clean up unused schedule pages and routes</name>
  <files>web/src/App.tsx</files>
  <action>
Since schedule creation is now modal-based, remove the page-based routes:

1. In `web/src/App.tsx`:
   - Remove import for `ScheduleNewPage`
   - Remove import for `ScheduleEditPage` (if it exists)
   - Remove routes: `/schedules/new` and `/schedules/:id`
   - Keep only `/schedules` route

2. **Do NOT delete the page files** (ScheduleNewPage.tsx, ScheduleEditPage.tsx) - they may be referenced elsewhere or useful for future. Just remove the routes.

If ScheduleEditPage doesn't exist, only remove ScheduleNewPage route.
  </action>
  <verify>
1. TypeScript compiles: `cd web && npx tsc --noEmit`
2. App.tsx no longer has /schedules/new route
  </verify>
  <done>
- /schedules/new route removed from App.tsx
- /schedules/:id route removed (if existed)
- Page files preserved (not deleted)
- TypeScript compiles without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete schedule creation flow with visual grid:
- WeeklyScheduleGrid component with 7×24 drag-paintable cells
- ScheduleModal for creating/editing schedules
- Updated SchedulesPage with modal integration and better list display
- CRON conversion utilities for grid ↔ CRON round-trip
  </what-built>
  <how-to-verify>
1. Start the development servers:
   ```bash
   # Terminal 1: Backend
   cd /Users/tylerwagner/snoozeql && go run cmd/server/main.go
   
   # Terminal 2: Frontend
   cd /Users/tylerwagner/snoozeql/web && npm run dev
   ```

2. Open http://localhost:5173/schedules

3. **Test empty state:**
   - If no schedules exist, verify you see "No schedules yet" message with "Create your first schedule" button

4. **Test schedule creation:**
   - Click "Create Schedule" button (either in header or empty state CTA)
   - Verify modal opens with:
     - Name input field
     - Description textarea
     - Timezone dropdown
     - 7×24 grid (days on left, hours on top)
   
5. **Test grid painting:**
   - Click a cell - it should toggle to sleep (dark/indigo color)
   - Click and drag across multiple cells - they should all paint the same state
   - Release mouse outside the grid - painting should stop

6. **Test CRON mode:**
   - Click "Switch to CRON" button
   - Verify text inputs appear for Sleep CRON and Wake CRON
   - Verify human-readable description appears below inputs
   - Click "Switch to Grid" to return to grid mode

7. **Test form submission:**
   - Enter a name like "Test Schedule"
   - Paint some sleep hours on the grid (e.g., Mon-Fri, 10pm-6am)
   - Click "Create Schedule"
   - Verify modal closes
   - Verify new schedule appears in the list

8. **Test schedule display:**
   - Verify the schedule list shows:
     - Name in first column
     - Active days summary (e.g., "Mon-Fri")
     - Sleep hours summary (e.g., "10pm-6am")
     - Enable/disable toggle
     - Edit and Delete buttons

9. **Test edit flow:**
   - Click "Edit" button on a schedule
   - Verify modal opens with existing data pre-populated
   - Verify grid shows existing sleep hours
   - Make a change, save, verify list updates

Expected behavior: Complete create/edit flow works via modal, grid painting is smooth, schedules persist and display correctly.
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. All TypeScript compiles: `cd web && npx tsc --noEmit`
2. Human verification of complete flow
3. Schedules created via UI persist in database
4. Edit flow pre-populates existing schedule data
</verification>

<success_criteria>
Phase 3 success criteria met:
1. User can create a schedule specifying start time, end time, and days of week (via visual grid or CRON)
2. Created schedules appear in the schedules list (with human-readable summaries)
</success_criteria>

<output>
After completion, create `.planning/phases/03-basic-scheduling/03-03-SUMMARY.md`
</output>
