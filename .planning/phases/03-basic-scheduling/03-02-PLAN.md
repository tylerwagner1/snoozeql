---
phase: 03-basic-scheduling
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - web/src/components/ScheduleModal.tsx
autonomous: true

must_haves:
  truths:
    - "Modal opens for schedule creation"
    - "User can enter a schedule name"
    - "User can paint sleep hours on the visual grid"
    - "User can switch to CRON text input mode"
    - "Submit creates schedule and closes modal"
  artifacts:
    - path: "web/src/components/ScheduleModal.tsx"
      provides: "Schedule create/edit modal with grid"
      exports: ["ScheduleModal"]
      min_lines: 120
  key_links:
    - from: "web/src/components/ScheduleModal.tsx"
      to: "web/src/components/WeeklyScheduleGrid.tsx"
      via: "import { WeeklyScheduleGrid }"
      pattern: "WeeklyScheduleGrid"
    - from: "web/src/components/ScheduleModal.tsx"
      to: "web/src/lib/cronUtils.ts"
      via: "import { gridToCron, cronToGrid }"
      pattern: "gridToCron|cronToGrid"
    - from: "web/src/components/ScheduleModal.tsx"
      to: "web/src/lib/api.ts"
      via: "api.createSchedule or api.updateSchedule"
      pattern: "api\\.(createSchedule|updateSchedule)"
---

<objective>
Create the ScheduleModal component for creating and editing schedules.

Purpose: Provide a modal dialog that contains the schedule form with the visual grid for time selection, name input, timezone selector, and optional CRON fallback mode.

Output: New `ScheduleModal.tsx` component that integrates WeeklyScheduleGrid and handles schedule CRUD.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-basic-scheduling/03-CONTEXT.md
@.planning/phases/03-basic-scheduling/03-RESEARCH.md
@web/src/components/ConfirmDialog.tsx
@web/src/components/WeeklyScheduleGrid.tsx
@web/src/lib/cronUtils.ts
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScheduleModal component</name>
  <files>web/src/components/ScheduleModal.tsx</files>
  <action>
Create `web/src/components/ScheduleModal.tsx` using Headless UI Dialog (same pattern as ConfirmDialog):

**Props interface:**
```typescript
interface ScheduleModalProps {
  isOpen: boolean;
  onClose: () => void;
  onSuccess: () => void;          // Called after successful create/update
  schedule?: Schedule | null;      // If provided, edit mode; otherwise create mode
}
```

**State:**
- `name: string` - schedule name (required)
- `description: string` - optional description
- `timezone: string` - defaults to 'America/New_York'
- `grid: boolean[][]` - initialized from `createEmptyGrid()` or `cronToGrid()` if editing
- `showCronMode: boolean` - toggle between grid and CRON text input
- `sleepCron: string` - manual CRON input for sleep
- `wakeCron: string` - manual CRON input for wake
- `loading: boolean` - submission state
- `error: string | null` - error message

**Imports:**
- `Dialog, DialogPanel, DialogTitle, DialogBackdrop` from '@headlessui/react'
- `WeeklyScheduleGrid` from './WeeklyScheduleGrid'
- `createEmptyGrid, gridToCron, cronToGrid, formatGridSummary` from '../lib/cronUtils'
- `api` from '../lib/api'

**Form structure:**
1. **Header:**
   - DialogTitle: "Create Schedule" or "Edit Schedule" based on mode
   - Close button (X icon) in top right

2. **Name input (required):**
   - Label: "Schedule Name"
   - Placeholder: "e.g., Nightly Sleep"
   - Required validation on submit

3. **Description textarea (optional):**
   - Label: "Description (Optional)"
   - Placeholder: "What this schedule does..."

4. **Timezone select:**
   - Label: "Timezone"
   - Options: America/New_York, America/Chicago, America/Denver, America/Los_Angeles, UTC, Europe/London, Asia/Tokyo, Australia/Sydney
   - Default: America/New_York

5. **Time selection section:**
   - Header: "Sleep Hours"
   - Subtext: "Paint the hours when databases should sleep (dark = sleep)"
   - Toggle button: "Switch to CRON" / "Switch to Grid"
   
   If grid mode (`!showCronMode`):
   - Render `<WeeklyScheduleGrid grid={grid} onChange={setGrid} />`
   - Below grid, show summary: "Sleep: {sleepHours} on {activeDays}"
   
   If CRON mode (`showCronMode`):
   - Two text inputs: Sleep CRON, Wake CRON
   - Small help text: "Standard 5-field CRON format"
   - Link to crontab.guru

6. **Footer:**
   - Cancel button (calls onClose)
   - Submit button: "Create Schedule" or "Save Changes"
   - Disable submit if name is empty or loading

**Mode switching logic:**
- When switching from grid to CRON: populate CRON fields from `gridToCron(grid)`
- When switching from CRON to grid: try `cronToGrid(sleepCron, wakeCron)`, on error show toast or keep existing grid
- Grid is source of truth - CRON mode is for power users

**Submit handler:**
- If grid mode: compute `{ sleepCron, wakeCron }` from `gridToCron(grid)`
- If CRON mode: use the text input values directly
- Validate: name required, at least one sleep hour (grid not all false, or CRON not empty)
- Call `api.createSchedule()` or `api.updateSchedule()` based on mode
- On success: call `onSuccess()`, then `onClose()`
- On error: set error state, show error message

**Edit mode initialization:**
- If `schedule` prop is provided:
  - Populate name, description, timezone from schedule
  - Call `cronToGrid(schedule.sleep_cron, schedule.wake_cron)` to populate grid
  - If cronToGrid fails, start in CRON mode with raw values

**Styling:**
- Match ConfirmDialog styling (slate-800 bg, slate-700 border, rounded-xl)
- Modal should be wider for the grid: `max-w-4xl` instead of `max-w-md`
- Grid section needs horizontal scroll on mobile: `overflow-x-auto`

**Validation messages:**
- "Schedule name is required"
- "Please select at least one sleep hour"
  </action>
  <verify>
1. TypeScript compiles: `cd web && npx tsc --noEmit`
2. Component exports `ScheduleModal`
  </verify>
  <done>
- `ScheduleModal.tsx` exists with create and edit mode support
- Grid mode shows WeeklyScheduleGrid component
- CRON mode shows text inputs
- Mode toggle preserves data (grid â†” CRON conversion)
- Submit calls correct API endpoint based on mode
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Install cronstrue for CRON descriptions</name>
  <files>web/package.json</files>
  <action>
Install the `cronstrue` package for human-readable CRON descriptions:

```bash
cd web && npm install cronstrue
```

Then update `cronUtils.ts` to add a function:

```typescript
import cronstrue from 'cronstrue';

export function describeCron(cron: string): string {
  try {
    return cronstrue.toString(cron);
  } catch {
    return 'Invalid CRON expression';
  }
}
```

This will be used in the modal to show users what their CRON expression means.

Update the ScheduleModal to use `describeCron()` to show human-readable text below CRON inputs when in CRON mode.
  </action>
  <verify>
1. `cronstrue` is in package.json dependencies
2. TypeScript compiles: `cd web && npx tsc --noEmit`
  </verify>
  <done>
- `cronstrue` installed in web/package.json
- `describeCron` function added to cronUtils.ts
- ScheduleModal shows human-readable CRON description
  </done>
</task>

</tasks>

<verification>
1. `cd web && npx tsc --noEmit` passes
2. `cronstrue` is in package.json
3. ScheduleModal component exports correctly
4. Code inspection confirms:
   - WeeklyScheduleGrid is imported and rendered
   - Mode toggle works between grid and CRON
   - API calls use correct endpoints
</verification>

<success_criteria>
- ScheduleModal renders with name input, grid, timezone selector
- Grid mode displays WeeklyScheduleGrid with drag painting
- CRON mode displays text inputs with human-readable descriptions
- Mode toggle preserves schedule data
- Submit creates schedule via API
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-basic-scheduling/03-02-SUMMARY.md`
</output>
