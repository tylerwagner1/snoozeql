---
phase: 03-basic-scheduling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/lib/cronUtils.ts
  - web/src/components/WeeklyScheduleGrid.tsx
autonomous: true

must_haves:
  truths:
    - "Grid displays 7 days × 24 hours of clickable cells"
    - "Clicking a cell toggles its sleep/wake state"
    - "Click-dragging paints multiple cells with consistent state"
    - "Grid state can be converted to CRON expressions"
    - "CRON expressions can be converted back to grid state"
  artifacts:
    - path: "web/src/lib/cronUtils.ts"
      provides: "Grid ↔ CRON conversion utilities"
      exports: ["gridToCron", "cronToGrid", "formatGridSummary"]
      min_lines: 50
    - path: "web/src/components/WeeklyScheduleGrid.tsx"
      provides: "7×24 visual grid component with drag painting"
      exports: ["WeeklyScheduleGrid"]
      min_lines: 80
  key_links:
    - from: "web/src/components/WeeklyScheduleGrid.tsx"
      to: "web/src/lib/cronUtils.ts"
      via: "import { gridToCron, cronToGrid }"
      pattern: "import.*cronUtils"
---

<objective>
Create the WeeklyScheduleGrid component and CRON conversion utilities.

Purpose: Provide the visual grid UI for schedule time selection with click-drag painting behavior, plus utilities to convert grid state to/from CRON expressions for storage.

Output: Two new files - `cronUtils.ts` with conversion functions and `WeeklyScheduleGrid.tsx` component.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-basic-scheduling/03-CONTEXT.md
@.planning/phases/03-basic-scheduling/03-RESEARCH.md
@web/src/lib/api.ts
@web/src/components/ConfirmDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CRON conversion utilities</name>
  <files>web/src/lib/cronUtils.ts</files>
  <action>
Create `web/src/lib/cronUtils.ts` with the following functions:

1. **Type definitions:**
   - `ScheduleGrid` type: `boolean[][]` (7 days × 24 hours, true = sleep)
   - `createEmptyGrid()`: Returns 7×24 grid of false values

2. **gridToCron(grid: ScheduleGrid)**: Convert grid to sleep/wake CRON expressions
   - For each day, find first contiguous sleep block (first true → last true before false)
   - Generate sleep CRON for sleep start hour, wake CRON for wake hour
   - Use standard 5-field CRON format: `minute hour * * day-of-week`
   - Days: 0=Sunday through 6=Saturday (but grid uses Monday=0, so map accordingly)
   - Return `{ sleepCron: string, wakeCron: string }` or null if no sleep hours
   - For simplicity in Phase 3: assume single contiguous sleep window per day, take the majority pattern across weekdays

3. **cronToGrid(sleepCron: string, wakeCron: string)**: Parse CRON and populate grid
   - Parse hour and day-of-week fields from CRON
   - Mark hours between sleep and wake as true (sleep)
   - Handle overnight schedules (sleep hour > wake hour means sleep crosses midnight)
   - Return populated `ScheduleGrid`

4. **formatGridSummary(grid: ScheduleGrid)**: Human-readable summary
   - Return object: `{ activeDays: string, sleepHours: string }`
   - activeDays: "Mon-Fri", "Weekdays", "Every day", "Sat, Sun", etc.
   - sleepHours: "10pm-6am", "22:00-06:00", or "No sleep hours" if empty

5. **Helper functions:**
   - `formatHour(hour: number, use24h?: boolean)`: Format hour as "10pm" or "22:00"
   - `getDayName(dayIndex: number)`: Return abbreviated day name for grid index

Grid index mapping: grid[0] = Monday, grid[6] = Sunday
CRON day mapping: 0 = Sunday, 1 = Monday, ... 6 = Saturday

Keep implementation simple for Phase 3 - complex multi-block schedules are deferred.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
cd web && npx tsc --noEmit
```
  </verify>
  <done>
- `cronUtils.ts` exists with all 5 functions exported
- TypeScript compiles with no errors
- Functions handle edge cases: empty grid, overnight schedules, single-day schedules
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WeeklyScheduleGrid component</name>
  <files>web/src/components/WeeklyScheduleGrid.tsx</files>
  <action>
Create `web/src/components/WeeklyScheduleGrid.tsx` implementing the 7×24 visual grid:

**Props interface:**
```typescript
interface WeeklyScheduleGridProps {
  grid: boolean[][];        // 7 days × 24 hours
  onChange: (grid: boolean[][]) => void;
  disabled?: boolean;
}
```

**Component structure:**
1. **Constants:**
   - `DAYS = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']`
   - `HOURS = Array.from({ length: 24 }, (_, i) => i)`

2. **State:**
   - `isDragging: boolean` - tracks if mouse is held down
   - `paintMode: boolean | null` - the value being painted (true=sleep, false=wake)

3. **Event handlers:**
   - `handleCellMouseDown(day, hour)`: Set dragging true, determine paintMode from opposite of current cell state, update cell
   - `handleCellMouseEnter(day, hour)`: If dragging & paintMode set, update cell to paintMode value
   - `handleMouseUp()`: Reset dragging and paintMode to null

4. **Critical: Document-level mouseup listener**
   - Use `useEffect` to attach `mouseup` listener to `document`
   - This ensures drag stops even if mouse released outside grid
   - Clean up listener on unmount

5. **Grid layout:**
   - Use CSS Grid: `grid-cols-[auto_repeat(24,1fr)]`
   - First column: day labels (Mon, Tue, etc.)
   - Header row: hour labels (0, 1, 2... or 12am, 1am if preferred)
   - Each cell: 
     - `h-6` height for compact but clickable size
     - Sleep (true): `bg-indigo-600` with hover `bg-indigo-500`
     - Wake (false): `bg-slate-900` with hover `bg-slate-800`
     - Smooth transitions with `transition-colors`

6. **Accessibility:**
   - `cursor-pointer` on cells
   - Add `role="grid"` to container
   - Consider `aria-label` on cells (optional for Phase 3)

**Anti-patterns to avoid:**
- Don't use `onClick` on cells (fires after mouseup, breaks drag)
- Don't track selection in CSS only - need state for form submission
- Make sure `updateCell` creates a new array (immutable update)

Use `clsx` for conditional classes (already in project).
  </action>
  <verify>
1. TypeScript compiles: `cd web && npx tsc --noEmit`
2. Component can be imported without errors
  </verify>
  <done>
- `WeeklyScheduleGrid.tsx` exists and exports the component
- Grid renders 7 rows × 24 columns plus labels
- Click toggles cell state
- Click-drag paints multiple cells with same state
- Mouse release outside grid stops dragging (document-level listener)
- TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. Both files exist and export their functions/components
2. `cd web && npx tsc --noEmit` passes with no errors
3. Manual inspection of code confirms:
   - cronUtils has all 5 required functions
   - WeeklyScheduleGrid has document-level mouseup listener
   - Grid uses proper immutable state updates
</verification>

<success_criteria>
- WeeklyScheduleGrid component renders a 7×24 interactive grid
- Click-drag painting works correctly (verified via code inspection)
- CRON utilities can convert grid → CRON → grid round-trip (for simple cases)
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-basic-scheduling/03-01-SUMMARY.md`
</output>
