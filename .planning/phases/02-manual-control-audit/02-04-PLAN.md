---
phase: 02-manual-control-audit
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - web/src/pages/InstancesPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can see checkbox column in instances table"
    - "User can select/deselect individual instances via checkbox"
    - "User can select/deselect all visible instances via header checkbox"
    - "User sees bulk action buttons when instances are selected"
    - "User sees confirmation dialog before bulk sleep/wake executes"
    - "User sees toast notification after bulk operation completes"
  artifacts:
    - path: "web/src/pages/InstancesPage.tsx"
      provides: "Multi-select table with bulk action buttons and confirmation dialogs"
      contains: "selectedIds"
      min_lines: 280
  key_links:
    - from: "web/src/pages/InstancesPage.tsx"
      to: "web/src/components/ConfirmDialog.tsx"
      via: "ConfirmDialog import and usage"
      pattern: "import.*ConfirmDialog"
    - from: "web/src/pages/InstancesPage.tsx"
      to: "web/src/lib/api.ts"
      via: "bulkStopInstances/bulkStartInstances calls"
      pattern: "api\\.bulk(Stop|Start)Instances"
---

<objective>
Add multi-select and bulk action buttons to InstancesPage with confirmation dialogs

Purpose: Users can select multiple instances and sleep/wake them in bulk with confirmation
Output: InstancesPage with checkbox selection, "Sleep Selected"/"Wake Selected" buttons, confirmation dialogs
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-manual-control-audit/02-RESEARCH.md
@.planning/phases/02-manual-control-audit/02-02-SUMMARY.md

@web/src/pages/InstancesPage.tsx
@web/src/components/ConfirmDialog.tsx
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add selection state to InstancesPage</name>
  <files>web/src/pages/InstancesPage.tsx</files>
  <action>
Update InstancesPage.tsx to add selection state management.

1. Add imports at the top:
```typescript
import { useState, useEffect, useMemo } from 'react'
import { Link, useSearchParams } from 'react-router-dom'
import toast from 'react-hot-toast'
import api from '../lib/api'
import type { Instance } from '../lib/api'
import { ConfirmDialog } from '../components/ConfirmDialog'
```

2. Add selection state inside the component (after existing useState calls):
```typescript
// Selection state
const [selectedIds, setSelectedIds] = useState<Set<string>>(new Set())
const [showConfirmDialog, setShowConfirmDialog] = useState<'sleep' | 'wake' | null>(null)
const [bulkLoading, setBulkLoading] = useState(false)

// Selection handlers
const toggleSelect = (id: string) => {
  setSelectedIds(prev => {
    const next = new Set(prev)
    if (next.has(id)) next.delete(id)
    else next.add(id)
    return next
  })
}

const selectAll = () => {
  setSelectedIds(new Set(filteredAndSortedInstances.map(i => i.id)))
}

const clearSelection = () => {
  setSelectedIds(new Set())
}

// Check if all filtered instances are selected
const allSelected = filteredAndSortedInstances.length > 0 && 
  filteredAndSortedInstances.every(i => selectedIds.has(i.id))

// Get selected instances for dialog
const selectedInstances = instances.filter(i => selectedIds.has(i.id))
const stoppableSelected = selectedInstances.filter(i => 
  i.status === 'available' || i.status === 'running'
)
const startableSelected = selectedInstances.filter(i => i.status === 'stopped')
```
  </action>
  <verify>File has selectedIds state and selection handlers defined</verify>
  <done>Selection state management added to InstancesPage</done>
</task>

<task type="auto">
  <name>Task 2: Add bulk operation handlers and UI elements</name>
  <files>web/src/pages/InstancesPage.tsx</files>
  <action>
1. Add bulk operation handlers (after selection handlers):
```typescript
// Bulk operation handlers
const handleBulkSleep = async () => {
  setBulkLoading(true)
  try {
    const idsToStop = stoppableSelected.map(i => i.id)
    const result = await api.bulkStopInstances(idsToStop)
    
    if (result.success.length > 0) {
      toast.success(`Stopped ${result.success.length} instance(s)`)
      // Update local state optimistically
      setInstances(prev => prev.map(inst => 
        result.success.includes(inst.id) ? { ...inst, status: 'stopping' } : inst
      ))
    }
    if (result.failed.length > 0) {
      toast.error(`Failed to stop ${result.failed.length} instance(s)`)
    }
    
    clearSelection()
    setShowConfirmDialog(null)
  } catch (err) {
    toast.error('Failed to stop instances')
    console.error(err)
  } finally {
    setBulkLoading(false)
  }
}

const handleBulkWake = async () => {
  setBulkLoading(true)
  try {
    const idsToStart = startableSelected.map(i => i.id)
    const result = await api.bulkStartInstances(idsToStart)
    
    if (result.success.length > 0) {
      toast.success(`Started ${result.success.length} instance(s)`)
      // Update local state optimistically
      setInstances(prev => prev.map(inst => 
        result.success.includes(inst.id) ? { ...inst, status: 'starting' } : inst
      ))
    }
    if (result.failed.length > 0) {
      toast.error(`Failed to start ${result.failed.length} instance(s)`)
    }
    
    clearSelection()
    setShowConfirmDialog(null)
  } catch (err) {
    toast.error('Failed to start instances')
    console.error(err)
  } finally {
    setBulkLoading(false)
  }
}
```

2. Add bulk action buttons in the header section (inside the flex container after the title div, around line 117):
```typescript
{/* Bulk action buttons */}
{selectedIds.size > 0 && (
  <div className="flex items-center gap-3 bg-slate-800/50 px-4 py-2 rounded-lg border border-slate-700">
    <span className="text-sm text-slate-400">{selectedIds.size} selected</span>
    <button
      onClick={() => setShowConfirmDialog('sleep')}
      disabled={stoppableSelected.length === 0}
      className="px-3 py-1.5 bg-yellow-600 hover:bg-yellow-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white text-xs font-medium rounded-lg transition-all shadow-lg shadow-yellow-500/20"
    >
      Sleep Selected ({stoppableSelected.length})
    </button>
    <button
      onClick={() => setShowConfirmDialog('wake')}
      disabled={startableSelected.length === 0}
      className="px-3 py-1.5 bg-green-600 hover:bg-green-500 disabled:bg-slate-600 disabled:cursor-not-allowed text-white text-xs font-medium rounded-lg transition-all shadow-lg shadow-green-500/20"
    >
      Wake Selected ({startableSelected.length})
    </button>
    <button
      onClick={clearSelection}
      className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 text-white text-xs font-medium rounded-lg transition-all"
    >
      Clear
    </button>
  </div>
)}
```

3. Add checkbox column to table header (as first th, before Name):
```typescript
<th className="px-4 py-4 text-left">
  <input
    type="checkbox"
    checked={allSelected}
    onChange={(e) => e.target.checked ? selectAll() : clearSelection()}
    className="rounded border-slate-600 bg-slate-700 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-800"
  />
</th>
```

4. Add checkbox column to table body (as first td in each row, before the name cell):
```typescript
<td className="px-4 py-4">
  <input
    type="checkbox"
    checked={selectedIds.has(instance.id)}
    onChange={() => toggleSelect(instance.id)}
    className="rounded border-slate-600 bg-slate-700 text-blue-500 focus:ring-blue-500 focus:ring-offset-slate-800"
  />
</td>
```

5. Add confirmation dialogs at the end of the component (before closing div):
```typescript
{/* Confirmation Dialogs */}
<ConfirmDialog
  isOpen={showConfirmDialog === 'sleep'}
  onClose={() => setShowConfirmDialog(null)}
  onConfirm={handleBulkSleep}
  title="Confirm Sleep Operation"
  message={`Are you sure you want to sleep ${stoppableSelected.length} database instance(s)? This will stop them and they won't be accessible until woken.`}
  confirmText={`Sleep ${stoppableSelected.length} Instance(s)`}
  confirmVariant="warning"
  loading={bulkLoading}
/>

<ConfirmDialog
  isOpen={showConfirmDialog === 'wake'}
  onClose={() => setShowConfirmDialog(null)}
  onConfirm={handleBulkWake}
  title="Confirm Wake Operation"
  message={`Are you sure you want to wake ${startableSelected.length} database instance(s)? This will start them and resume billing.`}
  confirmText={`Wake ${startableSelected.length} Instance(s)`}
  confirmVariant="success"
  loading={bulkLoading}
/>
```
  </action>
  <verify>`cd web && npm run build` compiles without errors</verify>
  <done>Bulk action buttons and confirmation dialogs integrated into InstancesPage</done>
</task>

</tasks>

<verification>
1. Frontend compiles: `cd web && npm run build`
2. Visual check (after starting dev server):
   - Table has checkbox column
   - Clicking checkbox selects row
   - Header checkbox selects/deselects all
   - Bulk action buttons appear when selection > 0
   - Clicking "Sleep Selected" opens confirmation dialog
</verification>

<success_criteria>
- Checkbox column appears in instances table (header and rows)
- Clicking individual checkbox toggles selection
- Header checkbox selects/deselects all visible (filtered) instances
- "Sleep Selected" and "Wake Selected" buttons appear when instances selected
- Buttons show count of actionable instances (stoppable/startable)
- Clicking bulk action button opens confirmation dialog
- Confirming dialog calls bulk API and shows toast
- Selection clears after successful operation
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-manual-control-audit/02-04-SUMMARY.md`
</output>
