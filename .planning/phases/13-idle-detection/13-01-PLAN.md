---
phase: 13-idle-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/analyzer/patterns.go
autonomous: true

must_haves:
  truths:
    - "Instance only flagged idle when CPU < 5% AND connections = 0"
    - "Instances with active connections never flagged as idle"
    - "Hour with CPU 4% and 1 connection is NOT idle"
    - "Hour with CPU 4% and 0 connections IS idle"
  artifacts:
    - path: "internal/analyzer/patterns.go"
      provides: "Compound idle threshold logic"
      contains: "cpu < thresholds.CPUPercent && conns == 0"
  key_links:
    - from: "findIdleSegments()"
      to: "ActivityThresholds"
      via: "CPUPercent and ConnectionsThreshold fields"
      pattern: "cpu < thresholds\\.CPUPercent && conns == 0"
---

<objective>
Update the idle detection algorithm to use a compound threshold: CPU < 5% AND connections = 0.

Purpose: Prevent false positives where instances have low CPU but active connections (maintenance queries, monitoring, etc.)
Output: Modified patterns.go with accurate idle detection
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/analyzer/patterns.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update ActivityThresholds struct and defaults</name>
  <files>internal/analyzer/patterns.go</files>
  <action>
Update the ActivityThresholds struct (lines 11-17) to add a connections threshold field:

1. Add `ConnectionsThreshold float64` field after `CPUPercent` with comment `// Connections must be exactly 0 for idle`

2. Update `DefaultThresholds()` function (lines 20-28):
   - Change `CPUPercent: 1.0` to `CPUPercent: 5.0` (requirement: CPU < 5%)
   - Add `ConnectionsThreshold: 0` after CPUPercent line

The struct should look like:
```go
type ActivityThresholds struct {
    CPUPercent          float64 // CPU < 5%
    ConnectionsThreshold float64 // Connections must be exactly 0 for idle
    QueriesPerMin       float64 // Queries < 5/min (approximated from connections/IOPS)
    MinIdleHours        int     // 8+ hours of low activity
    MinDataHours        int     // 24+ hours of data required
    MinDaysConsistent   int     // Require pattern on 3+ days
}
```
  </action>
  <verify>
Run `go build ./...` - should compile without errors.
  </verify>
  <done>
ActivityThresholds has ConnectionsThreshold field, CPUPercent defaults to 5.0, ConnectionsThreshold defaults to 0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update findIdleSegments to check compound threshold</name>
  <files>internal/analyzer/patterns.go</files>
  <action>
Update the `findIdleSegments()` function to check BOTH CPU AND connections for idle detection.

In the function (around line 183), find this logic:
```go
// Check if this hour is "idle" per CONTEXT.md thresholds
isIdle = cpu < thresholds.CPUPercent
```

Replace it with compound threshold check:
```go
// Check if this hour is "idle" per REC-01: CPU < 5% AND connections = 0
isIdle = cpu < thresholds.CPUPercent && conns <= thresholds.ConnectionsThreshold
```

This ensures:
- Hour with CPU 4%, connections 0 → idle (correct)
- Hour with CPU 4%, connections 1 → NOT idle (prevents false positive)
- Hour with CPU 6%, connections 0 → NOT idle (CPU too high)

Note: Use `<=` for connections since threshold is 0 and connections can't be negative.
  </action>
  <verify>
Run `go build ./...` and verify compilation.

Then manually verify the logic by reading the updated code:
```bash
grep -A2 "Check if this hour is" internal/analyzer/patterns.go
```
Should show the compound condition with both CPU and connections check.
  </verify>
  <done>
findIdleSegments() checks both CPU < 5% AND connections == 0 before marking an hour as idle.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update struct comment to reflect new threshold</name>
  <files>internal/analyzer/patterns.go</files>
  <action>
Update the comment on line 12 from:
```go
CPUPercent        float64 // CPU < 1%
```

To:
```go
CPUPercent        float64 // CPU < 5%
```

This keeps the documentation accurate with the new threshold value.
  </action>
  <verify>
```bash
grep "CPUPercent.*float64" internal/analyzer/patterns.go
```
Should show comment saying "CPU < 5%".
  </verify>
  <done>
Comment accurately reflects 5% CPU threshold.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   go build ./...
   ```
   Must compile without errors.

2. **Logic verification:**
   ```bash
   grep -B2 -A3 "isIdle = cpu" internal/analyzer/patterns.go
   ```
   Should show compound check: `cpu < thresholds.CPUPercent && conns <= thresholds.ConnectionsThreshold`

3. **Threshold verification:**
   ```bash
   grep "CPUPercent:" internal/analyzer/patterns.go
   ```
   Should show `CPUPercent: 5.0`

4. **Struct verification:**
   ```bash
   grep -A6 "type ActivityThresholds struct" internal/analyzer/patterns.go
   ```
   Should show both CPUPercent and ConnectionsThreshold fields.
</verification>

<success_criteria>
- [ ] Go build passes with no errors
- [ ] ActivityThresholds struct has ConnectionsThreshold field
- [ ] DefaultThresholds() returns CPUPercent: 5.0, ConnectionsThreshold: 0
- [ ] findIdleSegments() checks CPU < 5% AND connections == 0
- [ ] Comments accurately reflect 5% threshold
</success_criteria>

<output>
After completion, create `.planning/phases/13-idle-detection/13-01-SUMMARY.md`
</output>
