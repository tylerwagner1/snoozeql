---
phase: 11-time-series-visualization
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - web/src/components/MetricsChart.tsx
  - web/src/pages/InstanceDetailPage.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can see CPU chart on Instance Details page"
    - "User can switch between CPU, Memory, and Connections tabs"
    - "User can change time range (1h, 6h, 24h, 7d)"
    - "Loading spinner shows while fetching data"
    - "No data message shows when metrics are empty"
  artifacts:
    - path: "web/src/components/MetricsChart.tsx"
      provides: "Recharts-based metrics visualization component"
      min_lines: 100
      exports: ["MetricsChart"]
    - path: "web/src/pages/InstanceDetailPage.tsx"
      provides: "Instance page with embedded MetricsChart"
      contains: "MetricsChart"
  key_links:
    - from: "web/src/components/MetricsChart.tsx"
      to: "web/src/lib/api.ts"
      via: "useQuery calling api.getMetricsHistory"
      pattern: "api\\.getMetricsHistory"
    - from: "web/src/pages/InstanceDetailPage.tsx"
      to: "web/src/components/MetricsChart.tsx"
      via: "import and render"
      pattern: "import.*MetricsChart"
---

<objective>
Build the MetricsChart component with tabs, time range selector, and integrate into Instance Details page.

Purpose: Users need visual representation of metrics history to understand instance utilization patterns.
Output: Working time-series charts for CPU, Memory, and Connections with time range selection.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-time-series-visualization/11-CONTEXT.md
@.planning/phases/11-time-series-visualization/11-RESEARCH.md
@.planning/phases/11-time-series-visualization/11-01-SUMMARY.md

# Existing implementation files
@web/src/components/CostOverTimeChart.tsx
@web/src/pages/InstanceDetailPage.tsx
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MetricsChart component</name>
  <files>web/src/components/MetricsChart.tsx</files>
  <action>
Create a new MetricsChart component that displays time-series data with tabs and time range selector.

Requirements from CONTEXT.md:
- Tabbed view: CPU | Memory | Connections (default: CPU)
- Time range selector: 1h, 6h, 24h, 7d (default: 24h)
- Line chart (not area), no dots on data points
- Crosshair + tooltip on hover
- Fixed Y-axis: 0-100% for CPU/Memory, auto-scale for Connections
- Compact height (~150px)
- Loading: spinner centered in chart area
- Empty: show chart axes with "No data available" message
- Data gaps show as zero (handled by data - no explicit handling needed)

Implementation structure:
```typescript
import { useState, useMemo } from 'react'
import { useQuery } from '@tanstack/react-query'
import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  Tooltip,
  ResponsiveContainer,
  CartesianGrid,
} from 'recharts'
import api from '../lib/api'

type MetricTab = 'cpu' | 'memory' | 'connections'
type TimeRange = '1h' | '6h' | '24h' | '7d'

interface MetricsChartProps {
  instanceId: string
}

// Map tab to CloudWatch metric name
const metricNameMap: Record<MetricTab, string> = {
  cpu: 'CPUUtilization',
  memory: 'FreeableMemory',
  connections: 'DatabaseConnections',
}

// Format X-axis labels based on time range
const formatXAxis = (hour: string, range: TimeRange): string => {
  const date = new Date(hour)
  if (range === '1h' || range === '6h') {
    return date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
  }
  if (range === '24h') {
    return date.toLocaleTimeString('en-US', { hour: 'numeric' })
  }
  // 7d
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
}

export function MetricsChart({ instanceId }: MetricsChartProps) {
  const [activeTab, setActiveTab] = useState<MetricTab>('cpu')
  const [timeRange, setTimeRange] = useState<TimeRange>('24h')

  const { data, isLoading, error } = useQuery({
    queryKey: ['metrics-history', instanceId, timeRange],
    queryFn: () => api.getMetricsHistory(instanceId, timeRange),
  })

  // Filter data for active metric
  const chartData = useMemo(() => {
    if (!data) return []
    return data
      .filter(m => m.metric_name === metricNameMap[activeTab])
      .map(m => ({
        hour: m.hour,
        value: m.avg_value,
      }))
  }, [data, activeTab])

  const isPercentage = activeTab === 'cpu' || activeTab === 'memory'

  const tabs = [
    { key: 'cpu' as const, label: 'CPU' },
    { key: 'memory' as const, label: 'Memory' },
    { key: 'connections' as const, label: 'Connections' },
  ]

  const timeRanges: TimeRange[] = ['1h', '6h', '24h', '7d']

  return (
    <div className="bg-white shadow-sm border rounded-lg p-6">
      {/* Header with tabs and time range */}
      <div className="flex items-center justify-between mb-4">
        <div className="flex border-b border-gray-200">
          {tabs.map((tab) => (
            <button
              key={tab.key}
              onClick={() => setActiveTab(tab.key)}
              className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                activeTab === tab.key
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </div>
        
        <div className="flex bg-gray-100 rounded-lg p-1">
          {timeRanges.map((range) => (
            <button
              key={range}
              onClick={() => setTimeRange(range)}
              className={`px-3 py-1 text-sm rounded-md transition-colors ${
                timeRange === range
                  ? 'bg-white text-gray-900 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              {range}
            </button>
          ))}
        </div>
      </div>

      {/* Chart area */}
      {isLoading ? (
        <div className="h-[150px] flex items-center justify-center">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500" />
        </div>
      ) : error ? (
        <div className="h-[150px] flex items-center justify-center">
          <p className="text-red-500 text-sm">Failed to load metrics</p>
        </div>
      ) : chartData.length === 0 ? (
        <div className="h-[150px] relative">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={[{ hour: '', value: 0 }]}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
              <XAxis dataKey="hour" tick={{ fill: '#9ca3af', fontSize: 11 }} tickLine={false} axisLine={false} />
              <YAxis domain={[0, 100]} tick={{ fill: '#9ca3af', fontSize: 11 }} tickLine={false} axisLine={false} width={40} />
            </LineChart>
          </ResponsiveContainer>
          <div className="absolute inset-0 flex items-center justify-center">
            <p className="text-gray-500 text-sm">No data available</p>
          </div>
        </div>
      ) : (
        <div className="h-[150px]">
          <ResponsiveContainer width="100%" height="100%">
            <LineChart data={chartData} margin={{ top: 5, right: 5, left: 0, bottom: 5 }}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e5e7eb" />
              <XAxis
                dataKey="hour"
                tickFormatter={(h) => formatXAxis(h, timeRange)}
                tick={{ fill: '#9ca3af', fontSize: 11 }}
                tickLine={false}
                axisLine={false}
              />
              <YAxis
                domain={isPercentage ? [0, 100] : [0, 'auto']}
                tickFormatter={(v) => isPercentage ? `${v}%` : String(v)}
                tick={{ fill: '#9ca3af', fontSize: 11 }}
                tickLine={false}
                axisLine={false}
                width={40}
              />
              <Tooltip
                cursor={{ strokeDasharray: '3 3' }}
                contentStyle={{
                  background: '#fff',
                  border: '1px solid #e5e7eb',
                  borderRadius: '0.5rem',
                  fontSize: '12px',
                }}
                labelFormatter={(label) => new Date(label).toLocaleString()}
                formatter={(value: number) => [
                  isPercentage ? `${value.toFixed(1)}%` : value.toFixed(1),
                  activeTab === 'cpu' ? 'CPU' : activeTab === 'memory' ? 'Memory' : 'Connections'
                ]}
              />
              <Line
                type="monotone"
                dataKey="value"
                stroke="#3b82f6"
                dot={false}
                strokeWidth={2}
              />
            </LineChart>
          </ResponsiveContainer>
        </div>
      )}
    </div>
  )
}
```

Create this file at `web/src/components/MetricsChart.tsx`.
  </action>
  <verify>
Check file exists and contains expected exports: `grep -n "export function MetricsChart" web/src/components/MetricsChart.tsx`
  </verify>
  <done>
MetricsChart.tsx exists with tabs for CPU/Memory/Connections, time range selector, loading state, empty state, and line chart visualization
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate MetricsChart into InstanceDetailPage</name>
  <files>web/src/pages/InstanceDetailPage.tsx</files>
  <action>
Add the MetricsChart component to the Instance Details page.

Implementation:
1. Add import at top of file:
   ```typescript
   import { MetricsChart } from '../components/MetricsChart'
   ```

2. Add a new section for "Metrics History" AFTER the existing "Metrics" section (which shows current metrics cards).

Location: After the existing Metrics div (ends around line 418), add a new section:

Find this section (around line 355-418):
```tsx
<div className="bg-white shadow-sm border rounded-lg p-6">
  <div className="flex items-center justify-between mb-4">
    <h2 className="text-lg font-semibold text-gray-900">Metrics</h2>
    ...
  </div>
  ...
</div>
```

Add this new section immediately after it (before the closing `</div>` of the `lg:col-span-2` div around line 419):

```tsx
{/* Metrics History Chart */}
{id && (
  <div className="mt-6">
    <h2 className="text-lg font-semibold text-gray-900 mb-4">Metrics History</h2>
    <MetricsChart instanceId={id} />
  </div>
)}
```

Note: The MetricsChart is wrapped in a conditional to ensure `id` exists (it comes from useParams and could be undefined).
  </action>
  <verify>
Check integration: `grep -n "MetricsChart" web/src/pages/InstanceDetailPage.tsx`
  </verify>
  <done>
InstanceDetailPage.tsx imports and renders MetricsChart component with instanceId prop
  </done>
</task>

<task type="auto">
  <name>Task 3: Build and verify</name>
  <files></files>
  <action>
Run the frontend build to verify there are no TypeScript errors:

```bash
cd web && npm run build
```

If build fails, fix any TypeScript errors in MetricsChart.tsx or InstanceDetailPage.tsx.

Common issues to watch for:
- Missing imports (useQuery from @tanstack/react-query)
- Type mismatches with HourlyMetric interface
- Missing `id` check before passing to MetricsChart
  </action>
  <verify>
`cd web && npm run build` completes without errors
  </verify>
  <done>
Frontend builds successfully with MetricsChart component integrated
  </done>
</task>

</tasks>

<verification>
1. Component exists: `ls web/src/components/MetricsChart.tsx`
2. Import in page: `grep "MetricsChart" web/src/pages/InstanceDetailPage.tsx`
3. Build passes: `cd web && npm run build`
4. Manual verification (if server running):
   - Navigate to any instance detail page
   - See "Metrics History" section with tabs (CPU | Memory | Connections)
   - See time range buttons (1h, 6h, 24h, 7d)
   - See chart or "No data available" message
</verification>

<success_criteria>
- MetricsChart.tsx exists with tabbed interface (CPU, Memory, Connections)
- Time range selector works (1h, 6h, 24h, 7d)
- Default tab is CPU, default range is 24h
- Loading spinner shows while fetching
- "No data available" shows when empty
- InstanceDetailPage.tsx imports and renders MetricsChart
- Frontend builds without errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-time-series-visualization/11-02-SUMMARY.md`
</output>
