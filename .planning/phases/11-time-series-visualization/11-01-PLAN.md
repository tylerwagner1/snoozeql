---
phase: 11-time-series-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cmd/server/main.go
  - web/src/lib/api.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API returns metrics for specified time range"
    - "Frontend can fetch metrics history with range parameter"
    - "All three metrics (CPU, Memory, Connections) returned in single response"
  artifacts:
    - path: "cmd/server/main.go"
      provides: "GET /instances/{id}/metrics/history endpoint"
      contains: "metrics/history"
    - path: "web/src/lib/api.ts"
      provides: "getMetricsHistory() API method"
      contains: "getMetricsHistory"
  key_links:
    - from: "web/src/lib/api.ts"
      to: "cmd/server/main.go"
      via: "HTTP GET request"
      pattern: "/instances/.*/metrics/history"
---

<objective>
Create the metrics history API endpoint that returns time-series data for charting.

Purpose: Provides the data layer for time-series visualization - frontend needs historical metrics to render charts.
Output: Working API endpoint returning hourly metrics for specified time ranges (1h, 6h, 24h, 7d).
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-time-series-visualization/11-CONTEXT.md
@.planning/phases/11-time-series-visualization/11-RESEARCH.md

# Existing implementation files
@cmd/server/main.go
@internal/metrics/store.go
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add metrics history API endpoint</name>
  <files>cmd/server/main.go</files>
  <action>
Add a new GET endpoint at `/instances/{id}/metrics/history` that returns historical metrics for charting.

Implementation:
1. Add the route after the existing `/instances/{id}/metrics` endpoint (around line 670)
2. Parse query parameter `range` with values: "1h", "6h", "24h", "7d" (default: "24h")
3. Calculate time range:
   - "1h" -> 1 hour ago
   - "6h" -> 6 hours ago
   - "24h" -> 24 hours ago
   - "7d" -> 7 days ago
4. Call existing `metricsStore.GetMetricsByInstance(ctx, instanceID, start, end)`
5. Return JSON array of HourlyMetric objects

Pattern to follow (from line 652-670):
```go
r.Get("/instances/{id}/metrics/history", func(w http.ResponseWriter, r *http.Request) {
    instanceID := chi.URLParam(r, "id")
    rangeParam := r.URL.Query().Get("range")
    
    // Calculate duration based on range
    var duration time.Duration
    switch rangeParam {
    case "1h":
        duration = time.Hour
    case "6h":
        duration = 6 * time.Hour
    case "7d":
        duration = 7 * 24 * time.Hour
    default: // "24h" is default
        duration = 24 * time.Hour
    }
    
    start := time.Now().Add(-duration)
    end := time.Now()
    
    ctx := r.Context()
    metrics, err := metricsStore.GetMetricsByInstance(ctx, instanceID, start, end)
    if err != nil {
        log.Printf("ERROR: Failed to get metrics history: %v", err)
        w.Header().Set("Content-Type", "application/json")
        w.WriteHeader(http.StatusOK)
        json.NewEncoder(w).Encode([]models.HourlyMetric{})
        return
    }
    
    w.Header().Set("Content-Type", "application/json")
    w.WriteHeader(http.StatusOK)
    json.NewEncoder(w).Encode(metrics)
})
```

Note: Return empty array on error (consistent with existing `/metrics` endpoint pattern).
  </action>
  <verify>
Run: `curl -s "http://localhost:8080/api/v1/instances/test-id/metrics/history?range=24h" -H "Authorization: Bearer dev-key"` returns JSON array (empty is fine)
  </verify>
  <done>
GET /instances/{id}/metrics/history endpoint exists and returns hourly metrics for the specified time range
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontend API method</name>
  <files>web/src/lib/api.ts</files>
  <action>
Add `getMetricsHistory` method to the api object in api.ts.

Implementation:
1. Add new method after the existing `getInstanceMetrics` method (around line 251)
2. Accept instanceId and range parameters
3. Range type should be: "1h" | "6h" | "24h" | "7d"

Code to add:
```typescript
getMetricsHistory: (instanceId: string, range: '1h' | '6h' | '24h' | '7d' = '24h') =>
  api.get<HourlyMetric[]>(`/instances/${instanceId}/metrics/history?range=${range}`),
```

Place this after line 252 (after getInstanceMetrics) and before collectInstanceMetrics.
  </action>
  <verify>
Check file contains `getMetricsHistory` method with correct signature
  </verify>
  <done>
Frontend api.ts exports getMetricsHistory method that accepts instanceId and range parameter
  </done>
</task>

</tasks>

<verification>
1. Backend endpoint responds:
   ```bash
   curl -s "http://localhost:8080/api/v1/instances/test/metrics/history" -H "Authorization: Bearer dev-key" | jq .
   ```
2. Frontend builds without TypeScript errors: `cd web && npm run build`
3. API method is exported: `grep -n "getMetricsHistory" web/src/lib/api.ts`
</verification>

<success_criteria>
- GET /api/v1/instances/{id}/metrics/history endpoint returns HourlyMetric[] for time range
- Range parameter defaults to "24h" when not provided
- Frontend api.getMetricsHistory() method exists with correct types
- No build errors in frontend
</success_criteria>

<output>
After completion, create `.planning/phases/11-time-series-visualization/11-01-SUMMARY.md`
</output>
