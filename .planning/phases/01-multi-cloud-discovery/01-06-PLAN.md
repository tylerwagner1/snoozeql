---
phase: 01-multi-cloud-discovery
plan: 06
type: execute
wave: 3
depends_on: ["01-03", "01-04", "01-05"]
files_modified:
  - cmd/server/main.go
  - web/src/pages/InstancesPage.tsx
  - web/src/pages/Dashboard.tsx
autonomous: false

must_haves:
  truths:
    - "User can add AWS account and see RDS instances in the table"
    - "User can add GCP account and see Cloud SQL instances in the table"
    - "Instance statuses display correctly (running/stopped)"
    - "Connection status shows for each cloud account"
  artifacts:
    - path: "web/src/pages/InstancesPage.tsx"
      provides: "Complete instances table with all features"
    - path: "web/src/pages/CloudAccountsPage.tsx"
      provides: "Cloud accounts with connection status"
    - path: "web/src/pages/Dashboard.tsx"
      provides: "Dashboard with clickable stats"
  key_links:
    - from: "Dashboard stats"
      to: "InstancesPage filtered view"
      via: "URL navigation"
---

<objective>
Verify the complete Phase 1 flow end-to-end with a human checkpoint.

Purpose: Before marking Phase 1 complete, verify that all pieces work together: adding accounts, discovering instances, viewing in table, filtering, and status tracking.

Output: Verified working multi-cloud discovery with human confirmation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-multi-cloud-discovery/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update /stats endpoint with real instance counts</name>
  <files>cmd/server/main.go</files>
  <action>
Update the /api/v1/stats endpoint to return real data instead of hardcoded zeros:

1. Query instances from database to get counts:
   ```go
   r.Get("/stats", func(w http.ResponseWriter, r *http.Request) {
       ctx := r.Context()
       instances, err := discoveryService.ListAllDatabases(ctx)
       if err != nil {
           log.Printf("ERROR getting stats: %v", err)
           instances = []models.Instance{}
       }
       
       totalInstances := len(instances)
       runningInstances := 0
       stoppedInstances := 0
       
       for _, inst := range instances {
           switch inst.Status {
           case "available", "running", "starting", "RUNNABLE":
               runningInstances++
           case "stopped", "stopping", "SUSPENDED":
               stoppedInstances++
           }
       }
       
       stats := map[string]int{
           "total_instances":   totalInstances,
           "running_instances": runningInstances,
           "stopped_instances": stoppedInstances,
           "savings_7d":        0,  // TODO: implement in Phase 5
           "pending_actions":   0,  // TODO: implement in Phase 6
       }
       
       w.Header().Set("Content-Type", "application/json")
       json.NewEncoder(w).Encode(stats)
   })
   ```

This makes the dashboard stats reflect real instance states.
  </action>
  <verify>
`go build ./...` compiles. `curl http://localhost:8080/api/v1/stats` returns real counts matching instances.
  </verify>
  <done>
Stats endpoint returns real instance counts from discovery. Dashboard shows accurate running/stopped counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run database migrations for connection status</name>
  <files>deployments/docker/migrations/002_connection_status.sql</files>
  <action>
Ensure the connection status migration is applied:

1. Check if migration file exists (created in Plan 01)
2. Apply migration manually or ensure it runs on server start

If migration system isn't automated, apply directly:
```sql
-- Apply via psql or database tool
\i deployments/docker/migrations/002_connection_status.sql
```

Or add to server startup to run pending migrations.

For now, verify the columns exist:
```sql
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'cloud_accounts' 
AND column_name IN ('connection_status', 'last_sync_at', 'last_error');
```
  </action>
  <verify>
Database has connection_status, last_sync_at, last_error columns on cloud_accounts table.
  </verify>
  <done>
Migration applied. Cloud accounts table has connection status columns.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Phase 1 multi-cloud discovery flow:
- AWS and GCP provider registration with account-specific keys
- Instance persistence to database with sync on discovery
- Connection status tracking per cloud account
- Sortable, filterable instances table with account column
- Connection status chips on cloud accounts page
- Skeleton loading and toast notifications
- Clickable dashboard stats with URL-based filtering
- Prominent CTAs for adding accounts
  </what-built>
  <how-to-verify>
1. Start the server: `go run cmd/server/main.go`
2. Start the frontend: `cd web && npm run dev`
3. Open http://localhost:5173 in browser

Test the following flows:

**A. Add Cloud Account:**
1. Navigate to Cloud Accounts page
2. Click "Connect Account"
3. Add an AWS account with valid credentials
4. Verify account appears with "syncing" then "connected" status

**B. View Instances:**
1. Navigate to Instances page
2. Verify instances from your AWS account appear
3. Test sorting: click Name header, verify sort
4. Test filtering: select "Running Only", verify filter
5. Verify Account column shows account name

**C. Dashboard Navigation:**
1. Navigate to Dashboard
2. Verify Running/Sleeping counts match instances
3. Click Running Databases card
4. Verify navigation to /instances?status=running
5. Verify instances are pre-filtered

**D. Error Handling:**
1. Try adding invalid credentials
2. Verify toast notification appears
3. Verify account shows "failed" status with error

Report any issues found.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm Phase 1 is complete, or describe any issues that need fixing.</resume-signal>
</task>

</tasks>

<verification>
Phase 1 verification checklist:
1. [ ] AWS accounts can be added and show "connected" status
2. [ ] GCP accounts can be added and show "connected" status (if you have GCP)
3. [ ] Instances from all accounts appear in unified table
4. [ ] Table columns are sortable
5. [ ] Status and provider filters work
6. [ ] Account name column shows correct account
7. [ ] Dashboard stats are accurate
8. [ ] Clicking stats cards navigates to filtered view
9. [ ] Connection errors show toast notifications
10. [ ] Failed accounts show error message
</verification>

<success_criteria>
Phase 1 Success Criteria from ROADMAP.md:
1. User can add multiple AWS account connections and see their RDS instances
2. User can add multiple GCP project connections and see their Cloud SQL instances
3. User can see instance status (running/stopped/pending) for each database in the UI
4. Instances from all connected accounts appear in a unified list
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-cloud-discovery/01-06-SUMMARY.md`
</output>
