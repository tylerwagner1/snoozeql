---
phase: 01-multi-cloud-discovery
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - web/src/pages/InstancesPage.tsx
  - web/src/lib/api.ts
autonomous: true

must_haves:
  truths:
    - "User can sort instances table by clicking column headers"
    - "User can filter instances by status, provider, or region"
    - "User can see which cloud account each instance belongs to"
  artifacts:
    - path: "web/src/pages/InstancesPage.tsx"
      provides: "Sortable, filterable instances table with account column"
      contains: "sortConfig"
    - path: "web/src/lib/api.ts"
      provides: "Instance type with account_name field"
      contains: "account_name"
  key_links:
    - from: "web/src/pages/InstancesPage.tsx"
      to: "api.getInstances"
      via: "useEffect fetch"
      pattern: "api\\.getInstances"
---

<objective>
Add sorting, filtering, and account name column to the instances table.

Purpose: Users need to efficiently navigate instances across multiple cloud accounts. Sorting by any column and filtering by status/provider/region enables quick discovery. Account name column shows which connection each instance belongs to.

Output: Enhanced instances table with clickable sort headers, dropdown filters, and account name column.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-multi-cloud-discovery/01-CONTEXT.md
@.planning/phases/01-multi-cloud-discovery/01-RESEARCH.md

@web/src/pages/InstancesPage.tsx
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sorting to instances table</name>
  <files>web/src/pages/InstancesPage.tsx</files>
  <action>
Add sortable columns to the instances table:

1. Add sort state using useState:
   ```typescript
   const [sortConfig, setSortConfig] = useState<{
     key: keyof Instance
     direction: 'asc' | 'desc'
   }>({ key: 'name', direction: 'asc' })
   ```

2. Add sorted instances computation using useMemo:
   ```typescript
   const sortedInstances = useMemo(() => {
     return [...instances].sort((a, b) => {
       const aVal = a[sortConfig.key] ?? ''
       const bVal = b[sortConfig.key] ?? ''
       if (aVal < bVal) return sortConfig.direction === 'asc' ? -1 : 1
       if (aVal > bVal) return sortConfig.direction === 'asc' ? 1 : -1
       return 0
     })
   }, [instances, sortConfig])
   ```

3. Add sort handler:
   ```typescript
   const handleSort = (key: keyof Instance) => {
     setSortConfig(prev => ({
       key,
       direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
     }))
   }
   ```

4. Update table headers to be clickable with sort indicators:
   ```tsx
   <th 
     className="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider cursor-pointer hover:text-white"
     onClick={() => handleSort('name')}
   >
     Name {sortConfig.key === 'name' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
   </th>
   ```

5. Apply same pattern to: Name, Provider, Region, Engine, Status columns

6. Use `sortedInstances` instead of `instances` in the map

Import `useMemo` from React. Follow existing code style (no semicolons, 2 spaces).
  </action>
  <verify>
Frontend compiles (`npm run build` in web/). Clicking column headers sorts the table. Sort direction toggles on repeated clicks.
  </verify>
  <done>
Table headers are clickable and sort instances. Sort indicator (↑/↓) shows current sort column and direction.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add column filters for status and provider</name>
  <files>web/src/pages/InstancesPage.tsx</files>
  <action>
Add dropdown filters for quick filtering:

1. Add filter state:
   ```typescript
   const [filters, setFilters] = useState<{
     status: string
     provider: string
   }>({ status: 'all', provider: 'all' })
   ```

2. Add filtered + sorted computation:
   ```typescript
   const filteredAndSortedInstances = useMemo(() => {
     let filtered = instances
     
     if (filters.status !== 'all') {
       filtered = filtered.filter(i => i.status === filters.status)
     }
     if (filters.provider !== 'all') {
       filtered = filtered.filter(i => i.provider.startsWith(filters.provider))
     }
     
     return [...filtered].sort((a, b) => {
       // ... existing sort logic
     })
   }, [instances, filters, sortConfig])
   ```

3. Add filter dropdowns above table (between header and table):
   ```tsx
   <div className="flex gap-4 mb-4">
     <select
       value={filters.status}
       onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
       className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white"
     >
       <option value="all">All Status</option>
       <option value="available">Running</option>
       <option value="stopped">Stopped</option>
       <option value="starting">Starting</option>
       <option value="stopping">Stopping</option>
     </select>
     
     <select
       value={filters.provider}
       onChange={(e) => setFilters(prev => ({ ...prev, provider: e.target.value }))}
       className="px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-sm text-white"
     >
       <option value="all">All Providers</option>
       <option value="aws">AWS</option>
       <option value="gcp">GCP</option>
     </select>
   </div>
   ```

4. Update count display to show filtered count:
   ```tsx
   <p className="text-sm text-slate-400 mt-1">
     {filteredAndSortedInstances.length} of {instances.length} instances
   </p>
   ```

5. Use `filteredAndSortedInstances` in the table body map.

Follow existing Tailwind patterns for styling.
  </action>
  <verify>
Frontend compiles. Filter dropdowns appear above table. Selecting filter updates displayed instances. Count updates to show filtered/total.
  </verify>
  <done>
Status and provider filter dropdowns work. Instance count shows filtered vs total. Filters combine with sorting.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add account name column to instances table</name>
  <files>web/src/pages/InstancesPage.tsx, web/src/lib/api.ts</files>
  <action>
1. In `api.ts`, add `account_name` to Instance interface:
   ```typescript
   export interface Instance {
     id: string
     cloud_account_id: string
     account_name?: string  // Added: populated by backend
     provider: string
     // ... rest unchanged
   }
   ```

2. In `InstancesPage.tsx`, add Account column to table:
   
   In `<thead>`:
   ```tsx
   <th className="px-6 py-4 text-left text-xs font-semibold text-slate-400 uppercase tracking-wider cursor-pointer hover:text-white"
       onClick={() => handleSort('account_name' as keyof Instance)}>
     Account {sortConfig.key === 'account_name' && (sortConfig.direction === 'asc' ? '↑' : '↓')}
   </th>
   ```
   
   In `<tbody>` row, add after Name column:
   ```tsx
   <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-300">
     {instance.account_name || 'Unknown'}
   </td>
   ```

3. Reorder columns to be: Name, Account, Provider, Region, Engine, Type, Status, Actions

Note: Backend needs to populate account_name when returning instances (this is handled by Plan 01 instance store joining with cloud_accounts). If not yet populated, display "Unknown" gracefully.
  </action>
  <verify>
Frontend compiles. Account column appears in table. Column is sortable. Account name displays for instances (or "Unknown" if not populated yet).
  </verify>
  <done>
Account name column added to instances table. Column is sortable. Shows account name from cloud_accounts table.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` in web/ compiles without errors
2. Instance table shows sortable columns with ↑/↓ indicators
3. Filter dropdowns for Status and Provider work
4. Account column shows which cloud account each instance belongs to
5. Filtering and sorting work together correctly
6. Instance count updates to show filtered vs total
</verification>

<success_criteria>
- All columns are sortable by clicking header
- Sort direction indicator (↑/↓) shows on active column
- Status filter dropdown filters instances by status
- Provider filter dropdown filters instances by AWS/GCP
- Account name column shows cloud account name
- Filtered count shows "X of Y instances"
</success_criteria>

<output>
After completion, create `.planning/phases/01-multi-cloud-discovery/01-03-SUMMARY.md`
</output>
